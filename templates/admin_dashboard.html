<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>ZoZi Enhanced Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* Enhanced Sidebar */
        .sidebar {
            width: 300px;
            background: linear-gradient(180deg, #1a252f 0%, #2c3e50 100%);
            color: white;
            padding: 30px 20px;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.2);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar h1 {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 40px;
            text-align: center;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 8px;
        }

        .nav-link {
            display: block;
            padding: 18px 22px;
            color: white;
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 500;
            position: relative;
        }

        .nav-link:hover, .nav-link.active {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #1a252f;
            transform: translateX(8px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
        }

        .nav-link i {
            margin-right: 12px;
            width: 24px;
            text-align: center;
            font-size: 18px;
        }

        /* Main Content */
        .main-content {
            margin-left: 300px;
            padding: 30px;
            width: calc(100% - 300px);
            min-height: 100vh;
        }

        .content-header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            border-left: 5px solid #FFD700;
        }

        .content-header h2 {
            color: #2c3e50;
            font-size: 36px;
            margin-bottom: 12px;
        }

        .content-header p {
            color: #7f8c8d;
            font-size: 18px;
        }

        /* Enhanced Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 35px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 215, 0, 0.1);
        }

        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #FFD700, #FFA500);
        }

        .stat-icon {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 40px;
            opacity: 0.1;
        }

        .stat-value {
            font-size: 42px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 18px;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .stat-growth {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-growth.positive {
            color: #27ae60;
        }

        .stat-growth.negative {
            color: #e74c3c;
        }

        /* Enhanced Chart Containers */
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .parish-analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .chart-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .chart-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-title {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
        }

        .chart-subtitle {
            font-size: 14px;
            opacity: 0.8;
            margin-top: 5px;
        }

        .chart-content {
            padding: 25px;
            min-height: 400px;
            position: relative;
        }

        .chart-content.large {
            min-height: 500px;
        }

        /* Enhanced Tables */
        .data-section {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            overflow: hidden;
        }

        .section-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .section-title {
            font-size: 28px;
            font-weight: 600;
        }

        .section-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            min-width: 300px;
            font-size: 16px;
        }

        .search-box::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .filter-select {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
        }

        .table-container {
            padding: 30px;
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
        }

        .data-table th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 18px 15px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 3px solid #FFD700;
            font-size: 16px;
        }

        .data-table td {
            padding: 18px 15px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }

        .data-table tbody tr:hover {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        }

        /* Enhanced Parish Analytics */
        .parish-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .parish-stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .parish-stat-card:hover {
            border-color: #FFD700;
            transform: translateY(-3px);
        }

        .parish-stat-card .parish-name {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .parish-stat-card .parish-value {
            font-size: 32px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 5px;
        }

        .parish-stat-card .parish-label {
            font-size: 14px;
            color: #7f8c8d;
        }

        /* Enhanced Badges */
        .badge {
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge.seller {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            color: #2e7d32;
        }

        .badge.user {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #1565c0;
        }

        .badge.active {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            color: #2e7d32;
        }

        .badge.inactive {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            color: #c62828;
        }

        .badge.pending {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            color: #ef6c00;
        }

        .badge.completed {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            color: #2e7d32;
        }

        .badge.cancelled {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            color: #c62828;
        }

        /* Enhanced Action Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        /* Loading and Empty States */
        .loading {
            text-align: center;
            padding: 60px;
            color: #7f8c8d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #FFD700;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #7f8c8d;
        }

        .empty-state .icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .empty-state p {
            font-size: 16px;
            max-width: 400px;
            margin: 0 auto;
        }

        /* Section Toggle */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Enhanced Responsive Design */
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .parish-analytics-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 1000;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                width: 100%;
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .search-box {
                min-width: 100%;
            }
        }

        /* Activity Feed Enhancement */
        .activity-feed {
            max-height: 500px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }

        .activity-item:hover {
            background: #f8f9fa;
        }

        .activity-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
            font-size: 20px;
            flex-shrink: 0;
        }

        .activity-icon.user-register {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #1565c0;
        }

        .activity-icon.seller-register {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            color: #2e7d32;
        }

        .activity-icon.product-upload {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            color: #ef6c00;
        }

        .activity-icon.order-placed {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            color: #7b1fa2;
        }

        .activity-icon.system {
            background: linear-gradient(135deg, #fff8e1, #ffecb3);
            color: #f57c00;
        }

        .activity-content {
            flex-grow: 1;
        }

        .activity-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 6px;
            font-size: 16px;
        }

        .activity-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 4px;
        }

        .activity-time {
            font-size: 12px;
            color: #7f8c8d;
        }

        /* Chart Controls */
        .chart-controls {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .chart-controls-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-size: 14px;
            text-transform: uppercase;
            font-weight: 600;
            color: #FFD700;
            letter-spacing: 0.5px;
        }

        .chart-control {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chart-control:hover {
            background: rgba(255, 215, 0, 0.2);
        }

        .chart-control.active {
            background: #FFD700;
            color: #2c3e50;
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: #FFD700;
            color: #2c3e50;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }
        }

        /* Customer Chats Styles */
        .chat-interface {
            display: flex;
            gap: 20px;
            min-height: 500px;
        }

        .conversation-item {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .conversation-item:hover {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            transform: translateX(5px);
        }

        .conversation-item.active {
            background: linear-gradient(135deg, #006400, #228B22);
            color: white;
        }

        .conversation-item h5 {
            margin: 0 0 5px 0;
            font-size: 16px;
            font-weight: bold;
        }

        .conversation-item p {
            margin: 0;
            font-size: 14px;
            opacity: 0.8;
        }

        .message-item {
            margin: 10px 0;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 70%;
            animation: messageSlideIn 0.3s ease;
        }

        .message-item.user {
            background: linear-gradient(135deg, #006400, #228B22);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .message-item.support {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #333;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
            display: block;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Chat responsive updates */
        @media (max-width: 1200px) {
            .chat-interface {
                flex-direction: column;
            }

            .conversations-panel, .chat-viewer {
                width: 100% !important;
                padding: 10px !important;
            }
        }

        /* User Details Modal Styles */
        .user-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            animation: fadeIn 0.3s ease;
        }

        .user-modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            margin: 2% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 1200px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.4s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .user-modal-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-modal-header h2 {
            margin: 0;
            font-size: 28px;
            color: #FFD700;
        }

        .close-modal {
            color: #FFD700;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            line-height: 1;
        }

        .close-modal:hover {
            color: #FFA500;
            transform: rotate(90deg);
        }

        .user-modal-body {
            padding: 30px;
        }

        .user-info-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #FFD700;
        }

        .user-info-section h3 {
            color: #2c3e50;
            font-size: 22px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .info-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .info-label {
            font-weight: 600;
            color: #7f8c8d;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .info-value {
            color: #2c3e50;
            font-size: 16px;
            font-weight: 500;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .product-card-modal {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
        }

        .product-card-modal:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .product-card-modal.flagged {
            border: 2px solid #e74c3c;
        }

        .product-card-modal img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .product-card-modal .product-info {
            padding: 15px;
        }

        .product-card-modal .product-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .product-card-modal .product-price {
            color: #27ae60;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .product-card-modal .product-stats {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 10px;
        }

        .flagged-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(231, 76, 60, 0.95);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.4);
            z-index: 10;
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-card .stat-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .stat-label {
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
        }

        .product-revenue {
            font-size: 14px;
            color: #27ae60;
            font-weight: 600;
            margin-top: 5px;
        }

        .orders-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .orders-table th {
            background: #2c3e50;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .orders-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .orders-table tr:hover {
            background: #f8f9fa;
        }

        .flag-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .flag-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #e74c3c;
        }

        .flag-type {
            font-weight: bold;
            color: #e74c3c;
            text-transform: uppercase;
            font-size: 14px;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }

        .modal-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn-flag {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .modal-btn-flag:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .modal-btn-unflag {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .modal-btn-unflag:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .modal-btn-close {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
        }

        .modal-btn-close:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(149, 165, 166, 0.4);
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .modal-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .no-data-message {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-size: 16px;
        }

        .badge-large {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .badge-seller {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #2c3e50;
        }

        .badge-buyer {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        /* Toggle Switch for COD Access */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            cursor: pointer;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .toggle-switch:hover .toggle-slider {
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>
    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

    <div class="admin-container">
        <!-- Enhanced Sidebar -->
        <div class="sidebar" id="sidebar">
            <h1>üè™ ZoZi Admin</h1>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#dashboard" class="nav-link active" data-section="dashboard">
                        <i>üìä</i> Dashboard Overview
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#parish-analytics" class="nav-link" data-section="parish-analytics">
                        <i>üó∫Ô∏è</i> Parish Analytics
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#users" class="nav-link" data-section="users">
                        <i>üë•</i> User Management
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#sellers" class="nav-link" data-section="sellers">
                        <i>üè™</i> Seller Analytics
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#products" class="nav-link" data-section="products">
                        <i>üì¶</i> Product Management
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#orders" class="nav-link" data-section="orders">
                        <i>üõí</i> Order Analytics
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#financials" class="nav-link" data-section="financials">
                        <i>üí∞</i> Financial Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#demographics" class="nav-link" data-section="demographics">
                        <i>üìà</i> Demographics
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#chats" class="nav-link" data-section="chats">
                        <i>üí¨</i> Customer Chats
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#activity" class="nav-link" data-section="activity">
                        <i>üìã</i> Activity Monitor
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#settings" class="nav-link" data-section="settings">
                        <i>‚öôÔ∏è</i> Admin Settings
                    </a>
                </li>
                <li class="nav-item" style="margin-top: 30px;">
                    <a href="/logout" class="nav-link" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                        <i>üö™</i> Logout
                    </a>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Overview Section -->
            <div id="dashboard" class="section active">
                <div class="content-header">
                    <h2>üöÄ ZoZi Platform Dashboard</h2>
                    <p>Comprehensive analytics and insights for your Jamaican marketplace platform</p>
                </div>

                <!-- Enhanced Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">Total Users</div>
                        <div class="stat-growth positive" id="userGrowth">
                            <span>üìà</span> +0% this month
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üè™</div>
                        <div class="stat-value" id="totalSellers">0</div>
                        <div class="stat-label">Active Sellers</div>
                        <div class="stat-growth positive" id="sellerGrowth">
                            <span>üìà</span> +0% this month
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üì¶</div>
                        <div class="stat-value" id="totalProducts">0</div>
                        <div class="stat-label">Products Listed</div>
                        <div class="stat-growth positive" id="productGrowth">
                            <span>üìà</span> +0% this month
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üõí</div>
                        <div class="stat-value" id="totalOrders">0</div>
                        <div class="stat-label">Total Orders</div>
                        <div class="stat-growth positive" id="orderGrowth">
                            <span>üìà</span> +0% this month
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-value" id="totalRevenue">J$0</div>
                        <div class="stat-label">Total Revenue</div>
                        <div class="stat-growth positive" id="revenueGrowth">
                            <span>üìà</span> +0% this month
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üè¶</div>
                        <div class="stat-value" id="platformFees">J$0</div>
                        <div class="stat-label">Platform Fees (5%)</div>
                        <div class="stat-growth positive">
                            <span>üíé</span> Commission earned
                        </div>
                    </div>
                </div>

                <!-- Charts Grid -->
                <div class="charts-grid">
                    <!-- Revenue Chart -->
                    <div class="chart-container">
                        <div class="chart-controls">
                            <div>
                                <h3 class="chart-title">üìà Revenue Analytics</h3>
                                <div class="chart-subtitle">Real-time financial performance</div>
                            </div>
                            <div class="chart-controls-group">
                                <div class="control-group">
                                    <label>Timeframe:</label>
                                    <select id="timeframeSelect" class="chart-control">
                                        <option value="7d">7 Days</option>
                                        <option value="1m">1 Month</option>
                                        <option value="3m">3 Months</option>
                                        <option value="6m">6 Months</option>
                                        <option value="1y" selected>1 Year</option>
                                        <option value="all">All Time</option>
                                    </select>
                                </div>
                                <div class="control-group">
                                    <label>Type:</label>
                                    <select id="chartTypeSelect" class="chart-control">
                                        <option value="line" selected>Line</option>
                                        <option value="area">Area</option>
                                        <option value="bar">Bar</option>
                                        <option value="candlestick">Candlestick</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="chart-content large">
                            <div id="revenueChart"></div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <div>
                                <div class="chart-title">üîî Recent Activity</div>
                                <div class="chart-subtitle">Platform activity feed</div>
                            </div>
                        </div>
                        <div class="chart-content">
                            <div class="activity-feed" id="recentActivity">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    Loading recent activity...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats Row -->
                <div class="parish-analytics-grid">
                    <div class="chart-container">
                        <div class="chart-header">
                            <div>
                                <div class="chart-title">üìç Top Parishes</div>
                                <div class="chart-subtitle">Most active regions</div>
                            </div>
                        </div>
                        <div class="chart-content">
                            <canvas id="topParishesChart" height="300"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-header">
                            <div>
                                <div class="chart-title">üè∑Ô∏è Category Performance</div>
                                <div class="chart-subtitle">Sales by category</div>
                            </div>
                        </div>
                        <div class="chart-content">
                            <canvas id="categoryPerformanceChart" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Parish Analytics Section -->
            <div id="parish-analytics" class="section">
                <div class="content-header">
                    <h2>üó∫Ô∏è Parish Analytics Dashboard</h2>
                    <p>Detailed geographic distribution and performance analysis across Jamaica</p>
                </div>

                <!-- Parish Stats Grid -->
                <div class="parish-stats-grid" id="parishStatsGrid">
                    <!-- Will be populated dynamically -->
                </div>

                <!-- Parish Charts -->
                <div class="parish-analytics-grid">
                    <div class="chart-container">
                        <div class="chart-header">
                            <div>
                                <div class="chart-title">üë• Buyers by Parish</div>
                                <div class="chart-subtitle">User distribution across Jamaica</div>
                            </div>
                        </div>
                        <div class="chart-content">
                            <canvas id="buyersParishChart" height="400"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-header">
                            <div>
                                <div class="chart-title">üè™ Sellers by Parish</div>
                                <div class="chart-subtitle">Vendor distribution</div>
                            </div>
                        </div>
                        <div class="chart-content">
                            <canvas id="sellersParishChart" height="400"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-header">
                            <div>
                                <div class="chart-title">üõí Orders by Parish</div>
                                <div class="chart-subtitle">Purchase patterns by location</div>
                            </div>
                        </div>
                        <div class="chart-content">
                            <canvas id="ordersParishChart" height="400"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-header">
                            <div>
                                <div class="chart-title">üí∞ Revenue by Parish</div>
                                <div class="chart-subtitle">Financial performance by region</div>
                            </div>
                        </div>
                        <div class="chart-content">
                            <canvas id="revenueParishChart" height="400"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Parish Comparison Table -->
                <div class="data-section">
                    <div class="section-header">
                        <div class="section-title">üìä Parish Performance Comparison</div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Parish</th>
                                    <th>Buyers</th>
                                    <th>Sellers</th>
                                    <th>Orders</th>
                                    <th>Revenue</th>
                                    <th>Avg Order Value</th>
                                    <th>Market Share</th>
                                </tr>
                            </thead>
                            <tbody id="parishComparisonTable">
                                <tr>
                                    <td colspan="7" class="loading">
                                        <div class="spinner"></div>
                                        Loading parish data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div id="users" class="section">
                <div class="content-header">
                    <h2>üë• User Management</h2>
                    <p>Comprehensive user analytics and management tools</p>
                </div>

                <div class="data-section">
                    <div class="section-header">
                        <div class="section-title">All Platform Users</div>
                        <div class="section-controls">
                            <input type="text" class="search-box" placeholder="Search users by name, email, phone..." id="usersSearch">
                            <select class="filter-select" id="userSortFilter">
                                <option value="default">Default</option>
                                <option value="most_sales">Most Sales (Revenue)</option>
                                <option value="top_sellers">Top Sellers (Products)</option>
                                <option value="top_buyers">Top Buyers (Spent)</option>
                                <option value="most_orders">Most Orders</option>
                            </select>
                            <select class="filter-select" id="userTypeFilter">
                                <option value="">All Users</option>
                                <option value="buyer">Buyers Only</option>
                                <option value="seller">Sellers Only</option>
                                <option value="flagged">Flagged Users</option>
                            </select>
                            <select class="filter-select" id="userParishFilter">
                                <option value="">All Parishes</option>
                                <option value="Kingston">Kingston</option>
                                <option value="Saint Andrew">Saint Andrew</option>
                                <option value="Saint Catherine">Saint Catherine</option>
                                <option value="Clarendon">Clarendon</option>
                                <option value="Manchester">Manchester</option>
                                <option value="Saint Ann">Saint Ann</option>
                                <option value="Saint Mary">Saint Mary</option>
                                <option value="Saint James">Saint James</option>
                                <option value="Hanover">Hanover</option>
                                <option value="Westmoreland">Westmoreland</option>
                                <option value="Saint Elizabeth">Saint Elizabeth</option>
                                <option value="Trelawny">Trelawny</option>
                                <option value="Saint Thomas">Saint Thomas</option>
                                <option value="Portland">Portland</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>User Info</th>
                                    <th>Contact</th>
                                    <th>Location</th>
                                    <th>Type</th>
                                    <th>Orders</th>
                                    <th>Products</th>
                                    <th>Buyer Spent</th>
                                    <th>Seller Revenue</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr>
                                    <td colspan="10" class="loading">
                                        <div class="spinner"></div>
                                        Loading users...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Sellers Section -->
            <div id="sellers" class="section">
                <div class="content-header">
                    <h2>üè™ Seller Analytics</h2>
                    <p>Track seller performance and manage vendor accounts</p>
                </div>

                <!-- Seller Performance Grid -->
                <div class="parish-analytics-grid">
                    <div class="chart-container">
                        <div class="chart-header">
                            <div>
                                <div class="chart-title">‚≠ê Top Performing Sellers</div>
                                <div class="chart-subtitle">By revenue and ratings</div>
                            </div>
                        </div>
                        <div class="chart-content">
                            <canvas id="topSellersChart" height="300"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-header">
                            <div>
                                <div class="chart-title">üìä Seller Distribution</div>
                                <div class="chart-subtitle">Sellers by parish</div>
                            </div>
                        </div>
                        <div class="chart-content">
                            <canvas id="sellerDistributionChart" height="300"></canvas>
                        </div>
                    </div>
                </div>

                <div class="data-section">
                    <div class="section-header">
                        <div class="section-title">Seller Management</div>
                        <div class="section-controls">
                            <input type="text" class="search-box" placeholder="Search sellers..." id="sellerSearch">
                            <select class="filter-select" id="sellerParishFilter">
                                <option value="">All Parishes</option>
                                <!-- Parish options will be populated -->
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Seller Info</th>
                                    <th>Business Details</th>
                                    <th>Location</th>
                                    <th>Products</th>
                                    <th>Sales</th>
                                    <th>Revenue</th>
                                    <th>Rating</th>
                                    <th>Status</th>
                                    <th>COD Access</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sellersTableBody">
                                <tr>
                                    <td colspan="10" class="loading">
                                        <div class="spinner"></div>
                                        Loading sellers...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Products Section -->
            <div id="products" class="section">
                <div class="content-header">
                    <h2>üì¶ Product Management</h2>
                    <p>Monitor inventory, sales performance, and product analytics</p>
                </div>

                <!-- Product Stats -->
                <div class="parish-analytics-grid">
                    <div class="chart-container">
                        <div class="chart-header">
                            <div>
                                <div class="chart-title">üè∑Ô∏è Products by Category</div>
                                <div class="chart-subtitle">Inventory distribution</div>
                            </div>
                        </div>
                        <div class="chart-content">
                            <canvas id="productsCategoryChart" height="300"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-header">
                            <div>
                                <div class="chart-title">üìà Best Selling Products</div>
                                <div class="chart-subtitle">Top 10 by sales volume</div>
                            </div>
                        </div>
                        <div class="chart-content">
                            <canvas id="bestSellingChart" height="300"></canvas>
                        </div>
                    </div>
                </div>

                <div class="data-section">
                    <div class="section-header">
                        <div class="section-title">Product Inventory</div>
                        <div class="section-controls">
                            <input type="text" class="search-box" placeholder="Search products..." id="productSearch">
                            <select class="filter-select" id="productCategoryFilter">
                                <option value="">All Categories</option>
                                <option value="Men Clothing">Men Clothing</option>
                                <option value="Women Clothing">Women Clothing</option>
                                <option value="Beauty & Health">Beauty & Health</option>
                                <option value="Shoes">Shoes</option>
                                <option value="Jewelry">Jewelry</option>
                                <option value="Kids">Kids</option>
                                <option value="Sports & Outdoors">Sports & Outdoors</option>
                                <option value="Home & Kitchen">Home & Kitchen</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Seller</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Sold</th>
                                    <th>Revenue</th>
                                    <th>Listed</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <tr>
                                    <td colspan="10" class="loading">
                                        <div class="spinner"></div>
                                        Loading products...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Orders Section -->
            <div id="orders" class="section">
                <div class="content-header">
                    <h2>üõí Order Analytics</h2>
                    <p>Track orders, manage transactions, and analyze buying patterns</p>
                </div>

                <!-- Order Charts -->
                <div class="parish-analytics-grid">
                    <div class="chart-container">
                        <div class="chart-header">
                            <div>
                                <div class="chart-title">üìä Orders by Status</div>
                                <div class="chart-subtitle">Order fulfillment overview</div>
                            </div>
                        </div>
                        <div class="chart-content">
                            <canvas id="orderStatusChart" height="300"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-header">
                            <div>
                                <div class="chart-title">üí≥ Payment Methods</div>
                                <div class="chart-subtitle">Payment preferences</div>
                            </div>
                        </div>
                        <div class="chart-content">
                            <canvas id="paymentMethodsChart" height="300"></canvas>
                        </div>
                    </div>
                </div>

                <div class="data-section">
                    <div class="section-header">
                        <div class="section-title">Order Management</div>
                        <div class="section-controls">
                            <input type="text" class="search-box" placeholder="Search orders..." id="orderSearch">
                            <select class="filter-select" id="orderStatusFilter">
                                <option value="">All Orders</option>
                                <option value="pending">Pending</option>
                                <option value="confirmed">Confirmed</option>
                                <option value="shipped">Shipped</option>
                                <option value="delivered">Delivered</option>
                                <option value="cancelled">Cancelled</option>
                                <option value="refunded">Refunded</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Parish</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Payment</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Payment Verified</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                <tr>
                                    <td colspan="10" class="loading">
                                        <div class="spinner"></div>
                                        Loading orders...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Financials Section -->
            <div id="financials" class="section">
                <div class="content-header">
                    <h2>üí∞ Financial Dashboard</h2>
                    <p>Platform revenue, fees, payouts, and financial analytics</p>
                </div>

                <!-- Financial Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-value" id="totalRevenueFinancial">J$0</div>
                        <div class="stat-label">Total Platform Revenue</div>
                        <div class="stat-growth positive">
                            <span>üìà</span> All-time earnings
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üè¶</div>
                        <div class="stat-value" id="platformFeesFinancial">J$0</div>
                        <div class="stat-label">Platform Fees (5%)</div>
                        <div class="stat-growth positive">
                            <span>üíé</span> Commission earned
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üí∏</div>
                        <div class="stat-value" id="sellerPayouts">J$0</div>
                        <div class="stat-label">Seller Payouts</div>
                        <div class="stat-growth positive">
                            <span>ü§ù</span> Paid to vendors
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚Ü©Ô∏è</div>
                        <div class="stat-value" id="totalRefunds">J$0</div>
                        <div class="stat-label">Total Refunds</div>
                        <div class="stat-growth negative">
                            <span>üìâ</span> Customer returns
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-value" id="netProfit">J$0</div>
                        <div class="stat-label">Net Platform Profit</div>
                        <div class="stat-growth positive">
                            <span>üéØ</span> Bottom line
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìà</div>
                        <div class="stat-value" id="avgOrderValue">J$0</div>
                        <div class="stat-label">Avg Order Value</div>
                        <div class="stat-growth positive">
                            <span>üí°</span> Per transaction
                        </div>
                    </div>
                </div>

                <!-- Financial Charts -->
                <div class="parish-analytics-grid">
                    <div class="chart-container">
                        <div class="chart-header">
                            <div>
                                <div class="chart-title">üìà Monthly Revenue</div>
                                <div class="chart-subtitle">Last 12 months performance</div>
                            </div>
                        </div>
                        <div class="chart-content">
                            <canvas id="monthlyRevenueChart" height="400"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-header">
                            <div>
                                <div class="chart-title">üí∞ Revenue Breakdown</div>
                                <div class="chart-subtitle">Platform vs seller earnings</div>
                            </div>
                        </div>
                        <div class="chart-content">
                            <canvas id="revenueBreakdownChart" height="400"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Pending Seller Payouts Section -->
                <div class="data-section" style="margin-top: 40px;">
                    <div class="section-header">
                        <div class="section-title">üí∏ Pending Seller Payouts</div>
                        <div class="section-controls">
                            <button class="btn-refresh" onclick="loadPendingPayouts()">
                                <span>üîÑ</span> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Seller Info</th>
                                    <th>Payment Method</th>
                                    <th>Account Details</th>
                                    <th>Amount Requested</th>
                                    <th>Fee</th>
                                    <th>Net Payout</th>
                                    <th>Processing Time</th>
                                    <th>Request Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="payoutsTableBody">
                                <tr>
                                    <td colspan="9" class="loading">
                                        <div class="spinner"></div>
                                        Loading pending payouts...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="payout-summary" id="payoutSummary" style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; display: none;">
                        <h4 style="margin-bottom: 10px;">üìä Payout Summary</h4>
                        <p><strong>Total Pending Requests:</strong> <span id="totalPendingCount">0</span></p>
                        <p><strong>Total Amount:</strong> J$<span id="totalPendingAmount">0.00</span></p>
                    </div>
                </div>

                <!-- Payout History Section -->
                <div class="data-section" style="margin-top: 40px;">
                    <div class="section-header">
                        <div class="section-title">üìú Payout History</div>
                        <div class="section-controls">
                            <select class="filter-select" id="payoutStatusFilter" onchange="loadPayoutHistory()">
                                <option value="all">All Status</option>
                                <option value="completed">Completed</option>
                                <option value="failed">Failed</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Seller</th>
                                    <th>Method</th>
                                    <th>Amount</th>
                                    <th>Net Payout</th>
                                    <th>Status</th>
                                    <th>Requested</th>
                                    <th>Completed</th>
                                </tr>
                            </thead>
                            <tbody id="payoutHistoryTableBody">
                                <tr>
                                    <td colspan="7" class="loading">
                                        <div class="spinner"></div>
                                        Loading payout history...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Demographics Section -->
            <div id="demographics" class="section">
                <div class="content-header">
                    <h2>üìà Demographics & Insights</h2>
                    <p>User behavior, trends, and demographic analysis</p>
                </div>

                <!-- Demographics Charts -->
                <div class="parish-analytics-grid">
                    <div class="chart-container">
                        <div class="chart-header">
                            <div>
                                <div class="chart-title">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ User Demographics</div>
                                <div class="chart-subtitle">Age and gender distribution</div>
                            </div>
                        </div>
                        <div class="chart-content">
                            <canvas id="userDemographicsChart" height="300"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-header">
                            <div>
                                <div class="chart-title">üïí Shopping Patterns</div>
                                <div class="chart-subtitle">Peak shopping hours</div>
                            </div>
                        </div>
                        <div class="chart-content">
                            <canvas id="shoppingPatternsChart" height="300"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-header">
                            <div>
                                <div class="chart-title">üì± Device Usage</div>
                                <div class="chart-subtitle">Mobile vs desktop usage</div>
                            </div>
                        </div>
                        <div class="chart-content">
                            <canvas id="deviceUsageChart" height="300"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-header">
                            <div>
                                <div class="chart-title">üìà Growth Trends</div>
                                <div class="chart-subtitle">User acquisition over time</div>
                            </div>
                        </div>
                        <div class="chart-content">
                            <canvas id="growthTrendsChart" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customer Chats Section -->
            <div id="chats" class="section">
                <div class="content-header">
                    <h2>üí¨ Customer Chats</h2>
                    <p>Monitor and manage customer support conversations</p>
                </div>
                <div class="data-section">
                    <div class="section-header">
                        <h3>üáØüá≤ Active Support Conversations</h3>
                        <div class="search-container">
                            <input type="text" id="chatSearch" placeholder="Search conversations..." style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; width: 300px;">
                            <button onclick="loadChats()" style="padding: 8px 16px; background: #FFD700; border: none; border-radius: 8px; margin-left: 10px; cursor: pointer;">üîÑ Refresh</button>
                        </div>
                    </div>
                    <div id="chatsContainer" style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
                        <div class="chat-interface">
                            <div class="conversations-panel" style="width: 40%; border-right: 2px solid #FFD700; padding-right: 20px;">
                                <h4 style="color: #006400; margin-bottom: 15px;">üó®Ô∏è Conversations</h4>
                                <div id="conversationsList" style="max-height: 500px; overflow-y: auto;">
                                    <div class="loading-state" style="text-align: center; padding: 40px; color: #666;">
                                        Loading conversations...
                                    </div>
                                </div>
                            </div>
                            <div class="chat-viewer" style="width: 60%; padding-left: 20px;">
                                <h4 style="color: #006400; margin-bottom: 15px;">üí≠ Chat Messages</h4>
                                <div id="chatMessages" style="height: 400px; border: 2px solid #FFD700; border-radius: 10px; padding: 15px; overflow-y: auto; background: linear-gradient(to bottom, #E6F3FF, #F0F8FF);">
                                    <div class="no-chat-selected" style="text-align: center; padding: 100px 20px; color: #666;">
                                        <div style="font-size: 48px; margin-bottom: 20px;">üáØüá≤</div>
                                        <h3>Select a conversation</h3>
                                        <p>Choose a chat from the left to view messages</p>
                                    </div>
                                </div>
                                <div class="admin-reply-section" id="replySection" style="display: none; margin-top: 15px;">
                                    <div style="display: flex; gap: 10px;">
                                        <input type="text" id="adminReply" placeholder="Type your response..." style="flex: 1; padding: 12px; border: 2px solid #FFD700; border-radius: 8px; font-size: 14px;">
                                        <button onclick="sendAdminReply()" style="padding: 12px 20px; background: linear-gradient(135deg, #006400, #228B22); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">Send üöÄ</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Monitor Section -->
            <div id="activity" class="section">
                <div class="content-header">
                    <h2>üìã Activity Monitor</h2>
                    <p>Real-time platform activity and system logs</p>
                </div>

                <div class="data-section">
                    <div class="section-header">
                        <div class="section-title">Platform Activity Stream</div>
                        <div class="section-controls">
                            <select class="filter-select" id="activityTypeFilter">
                                <option value="">All Activities</option>
                                <option value="user_register">User Registrations</option>
                                <option value="seller_register">Seller Registrations</option>
                                <option value="product_upload">Product Uploads</option>
                                <option value="order_placed">Orders Placed</option>
                                <option value="admin_action">Admin Actions</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-content">
                        <div class="activity-feed" style="max-height: 700px;" id="activityLog">
                            <div class="loading">
                                <div class="spinner"></div>
                                Loading activity log...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings" class="section">
                <div class="content-header">
                    <h2>‚öôÔ∏è Admin Settings</h2>
                    <p>Manage admin accounts and platform configuration</p>
                </div>

                <!-- Add Admin Form -->
                <div class="data-section">
                    <div class="section-header">
                        <div class="section-title">Add New Admin User</div>
                    </div>
                    <div class="table-container">
                        <div style="max-width: 600px; margin-bottom: 30px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <input type="email" id="adminEmail" placeholder="Admin Email" style="padding: 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px;">
                                <input type="password" id="adminPassword" placeholder="Password" style="padding: 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px;">
                            </div>
                            <div style="margin-bottom: 20px;">
                                <select id="adminLevel" style="width: 100%; padding: 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px;">
                                    <option value="admin">Admin</option>
                                    <option value="super_admin">Super Admin</option>
                                </select>
                            </div>
                            <button id="addAdminBtn" class="btn btn-success" style="padding: 15px 30px; font-size: 16px;">Add Admin User</button>
                        </div>
                    </div>
                </div>

                <!-- Admin Users List -->
                <div class="data-section">
                    <div class="section-header">
                        <div class="section-title">Current Admin Users</div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Level</th>
                                    <th>Created By</th>
                                    <th>Created Date</th>
                                    <th>Last Login</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="adminUsersTable">
                                <tr>
                                    <td colspan="7" class="loading">
                                        <div class="spinner"></div>
                                        Loading admin users...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Global variables
        let currentSection = 'dashboard';
        let charts = {};
        let revenueChart = null;

        // Jamaica parishes list
        const JAMAICA_PARISHES = [
            'Kingston', 'Saint Andrew', 'Saint Catherine', 'Clarendon', 'Manchester',
            'Saint Ann', 'Saint Mary', 'Saint James', 'Hanover', 'Westmoreland',
            'Saint Elizabeth', 'Trelawny', 'Saint Thomas', 'Portland'
        ];

        // Mobile sidebar toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        // Enhanced API helper function
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(endpoint, {
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || '',
                        ...options.headers
                    },
                    ...options
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.message || 'API request failed');
                }

                return data;
            } catch (error) {
                console.error(`API call to ${endpoint} failed:`, error);
                return { success: false, error: error.message, data: null };
            }
        }

        // Enhanced notification system
        function showNotification(message, type = 'info', duration = 5000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                opacity: 0;
                transform: translateY(-20px);
                transition: all 0.3s ease;
                max-width: 400px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            `;

            const colors = {
                success: '#27ae60',
                error: '#e74c3c',
                warning: '#f39c12',
                info: '#3498db'
            };
            notification.style.background = colors[type] || colors.info;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateY(0)';
            }, 100);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-20px)';
                setTimeout(() => notification.remove(), 300);
            }, duration);
        }

        // Navigation system
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = link.dataset.section;
                if (section) {
                    showSection(section);
                }
            });
        });

        function showSection(sectionName) {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-section="${sectionName}"]`)?.classList.add('active');

            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionName)?.classList.add('active');

            currentSection = sectionName;
            loadSectionData(sectionName);

            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('open');
            }
        }

        // Load section-specific data
        async function loadSectionData(section) {
            switch (section) {
                case 'dashboard':
                    await loadDashboard();
                    break;
                case 'parish-analytics':
                    await loadParishAnalytics();
                    break;
                case 'users':
                    await loadUsers();
                    break;
                case 'sellers':
                    await loadSellers();
                    break;
                case 'products':
                    await loadProducts();
                    break;
                case 'orders':
                    await loadOrders();
                    break;
                case 'financials':
                    await loadFinancials();
                    break;
                case 'demographics':
                    await loadDemographics();
                    break;
                case 'activity':
                    await loadActivityLog();
                    break;
                case 'settings':
                    await loadAdminUsers();
                    break;
            }
        }

        // Dashboard functions - UPDATED TO USE REAL DATA
        async function loadDashboard() {
            try {
                // Load real dashboard stats
                const response = await apiCall('/admin/api/dashboard_stats');
                if (response.success) {
                    updateDashboardStats(response);
                } else {
                    console.error('Error loading dashboard stats:', response.error);
                    showNotification('Error loading dashboard data', 'error');
                }

                // Load charts with real data
                await createRevenueChart();
                await loadRecentActivity();
                await createQuickCharts();

            } catch (error) {
                console.error('Error loading dashboard:', error);
                showNotification('Error loading dashboard data', 'error');
            }
        }

        function updateDashboardStats(data) {
            document.getElementById('totalUsers').textContent = data.totalUsers || 0;
            document.getElementById('totalSellers').textContent = data.totalSellers || 0;
            document.getElementById('totalProducts').textContent = data.totalProducts || 0;
            document.getElementById('totalOrders').textContent = data.totalOrders || 0;
            document.getElementById('totalRevenue').textContent = data.totalRevenue || 'J$0.00';
            document.getElementById('platformFees').textContent = data.platformFees || 'J$0.00';
            document.getElementById('userGrowth').innerHTML = `<span>üìà</span> ${data.userGrowth || '+0%'} this month`;
            document.getElementById('sellerGrowth').innerHTML = `<span>üìà</span> ${data.sellerGrowth || '+0%'} this month`;
            document.getElementById('productGrowth').innerHTML = `<span>üìà</span> ${data.productGrowth || '+0%'} this month`;
            document.getElementById('orderGrowth').innerHTML = `<span>üìà</span> ${data.orderGrowth || '+0%'} this month`;
            document.getElementById('revenueGrowth').innerHTML = `<span>üìà</span> ${data.revenueGrowth || '+0%'} this month`;
        }

        // FIXED: Revenue chart with real data
        async function createRevenueChart() {
            try {
                const response = await apiCall('/admin/api/revenue_data?timeframe=1y&chart_type=line');

                let chartData = [];
                if (response.success && response.data && response.data.length > 0) {
                    chartData = response.data;
                } else {
                    // Show empty state for no revenue data
                    chartData = [{
                        x: new Date().getTime(),
                        y: 0
                    }];
                }

                const options = {
                    series: [{
                        name: 'Revenue (JMD)',
                        data: chartData
                    }],
                    chart: {
                        type: 'area',
                        height: 400,
                        background: 'transparent',
                        toolbar: { show: true }
                    },
                    colors: ['#FFD700'],
                    fill: {
                        type: 'gradient',
                        gradient: {
                            shadeIntensity: 1,
                            opacityFrom: 0.7,
                            opacityTo: 0.1
                        }
                    },
                    stroke: {
                        curve: 'smooth',
                        width: 3
                    },
                    xaxis: {
                        type: 'datetime'
                    },
                    yaxis: {
                        labels: {
                            formatter: function (value) {
                                return 'J$' + value.toLocaleString();
                            }
                        }
                    },
                    tooltip: {
                        y: {
                            formatter: function (value) {
                                return 'J$' + value.toLocaleString();
                            }
                        }
                    },
                    annotations: chartData.length <= 1 ? {
                        yaxis: [{
                            y: 0,
                            borderColor: '#999',
                            label: {
                                show: true,
                                text: 'No revenue data yet - Start selling to see revenue!',
                                style: {
                                    color: "#fff",
                                    background: '#00E396'
                                }
                            }
                        }]
                    } : {}
                };

                if (revenueChart) revenueChart.destroy();
                revenueChart = new ApexCharts(document.getElementById('revenueChart'), options);
                revenueChart.render();
            } catch (error) {
                console.error('Error creating revenue chart:', error);
                document.getElementById('revenueChart').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìä</div>
                        <h3>Revenue Chart</h3>
                        <p>Revenue data will appear here as orders are placed</p>
                    </div>
                `;
            }
        }

        // FIXED: Recent activity with real data
        async function loadRecentActivity() {
            try {
                const response = await apiCall('/admin/api/recent_activity');
                const container = document.getElementById('recentActivity');

                if (response.success && response.activities?.length > 0) {
                    container.innerHTML = '';
                    response.activities.slice(0, 8).forEach(activity => {
                        const activityItem = createActivityItem(activity);
                        container.appendChild(activityItem);
                    });
                } else {
                    container.innerHTML = createEmptyActivityState();
                }
            } catch (error) {
                console.error('Error loading recent activity:', error);
                document.getElementById('recentActivity').innerHTML = createEmptyActivityState();
            }
        }

        function createActivityItem(activity) {
            const item = document.createElement('div');
            item.className = 'activity-item';

            const iconMap = {
                'user_register': { icon: 'üë§', class: 'user-register' },
                'seller_register': { icon: 'üè™', class: 'seller-register' },
                'product_upload': { icon: 'üì¶', class: 'product-upload' },
                'order_placed': { icon: 'üõí', class: 'order-placed' },
                'admin_action': { icon: '‚öôÔ∏è', class: 'system' },
                'default': { icon: 'üìã', class: 'system' }
            };

            const activityType = activity.action || activity.action_type || 'default';
            const icon = iconMap[activityType] || iconMap.default;

            item.innerHTML = `
                <div class="activity-icon ${icon.class}">${icon.icon}</div>
                <div class="activity-content">
                    <div class="activity-title">${activity.action_type || activity.action || 'Platform Activity'}</div>
                    <div class="activity-description">${activity.description || activity.user || 'Activity performed'}</div>
                    <div class="activity-time">${activity.time || 'Recently'}</div>
                </div>
            `;

            return item;
        }

        function createEmptyActivityState() {
            return `
                <div class="empty-state">
                    <div class="icon">üöÄ</div>
                    <h3>Platform Ready!</h3>
                    <p>Activity will appear here as users interact with your marketplace</p>
                </div>
            `;
        }

        // FIXED: Quick charts with real data
        async function createQuickCharts() {
            try {
                // Get real analytics data
                const analyticsResponse = await apiCall('/admin/api/analytics');
                const parishResponse = await apiCall('/admin/api/parish_analytics');

                if (analyticsResponse.success && analyticsResponse.category_data?.length > 0) {
                    // Real category performance chart
                    const categories = analyticsResponse.category_data.slice(0, 6);
                    await createChart('categoryPerformanceChart', 'bar', {
                        labels: categories.map(cat => cat.category || 'Unknown'),
                        datasets: [{
                            label: 'Products',
                            data: categories.map(cat => cat.products_count || 0),
                            backgroundColor: '#4ECDC4'
                        }]
                    });
                } else {
                    // Empty state for categories
                    document.getElementById('categoryPerformanceChart').parentElement.innerHTML = `
                        <div class="chart-header">
                            <div>
                                <div class="chart-title">üè∑Ô∏è Category Performance</div>
                                <div class="chart-subtitle">Products by category</div>
                            </div>
                        </div>
                        <div class="chart-content">
                            <div class="empty-state">
                                <div class="icon">üè∑Ô∏è</div>
                                <h3>No Categories Yet</h3>
                                <p>Category data will appear as products are added</p>
                            </div>
                        </div>
                    `;
                }

                if (parishResponse.success && parishResponse.buyers_by_parish?.length > 0) {
                    // Real parish distribution chart
                    const topParishes = parishResponse.buyers_by_parish.slice(0, 6);
                    await createChart('topParishesChart', 'doughnut', {
                        labels: topParishes.map(parish => parish.parish),
                        datasets: [{
                            data: topParishes.map(parish => parish.buyer_count),
                            backgroundColor: [
                                '#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1',
                                '#96CEB4', '#FECA57'
                            ]
                        }]
                    });
                } else {
                    // Empty state for parishes
                    document.getElementById('topParishesChart').parentElement.innerHTML = `
                        <div class="chart-header">
                            <div>
                                <div class="chart-title">üìç Top Parishes</div>
                                <div class="chart-subtitle">User distribution</div>
                            </div>
                        </div>
                        <div class="chart-content">
                            <div class="empty-state">
                                <div class="icon">üìç</div>
                                <h3>No Parish Data Yet</h3>
                                <p>Parish distribution will appear as users register</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error creating quick charts:', error);
            }
        }

        // FIXED: Parish Analytics with real data
        async function loadParishAnalytics() {
            try {
                const response = await apiCall('/admin/api/parish_analytics');

                if (response.success) {
                    createParishStatsGrid(response);
                    createParishCharts(response);
                    createParishComparisonTable(response);
                } else {
                    // Show empty states for parish analytics
                    showEmptyParishAnalytics();
                }
            } catch (error) {
                console.error('Error loading parish analytics:', error);
                showEmptyParishAnalytics();
                showNotification('Error loading parish analytics', 'error');
            }
        }

        function showEmptyParishAnalytics() {
            document.getElementById('parishStatsGrid').innerHTML = `
                <div class="empty-state" style="grid-column: 1 / -1; padding: 40px;">
                    <div class="icon">üó∫Ô∏è</div>
                    <h3>No Parish Data Yet</h3>
                    <p>Parish analytics will appear as users register from different locations</p>
                </div>
            `;
        }

        function createParishStatsGrid(data) {
            const grid = document.getElementById('parishStatsGrid');
            grid.innerHTML = '';

            if (!data.parish_stats || data.parish_stats.length === 0) {
                showEmptyParishAnalytics();
                return;
            }

            // Get top 6 parishes by total activity
            const topParishes = data.parish_stats
                .sort((a, b) => (b.buyers + b.sellers + b.orders) - (a.buyers + a.sellers + a.orders))
                .slice(0, 6);

            topParishes.forEach(parish => {
                const card = document.createElement('div');
                card.className = 'parish-stat-card';
                card.innerHTML = `
                    <div class="parish-name">${parish.parish}</div>
                    <div class="parish-value">${parish.buyers + parish.sellers}</div>
                    <div class="parish-label">Total Users</div>
                `;
                grid.appendChild(card);
            });
        }

        function createParishCharts(data) {
            // Only create charts if we have data
            if (data.buyers_by_parish && data.buyers_by_parish.length > 0) {
                createChart('buyersParishChart', 'doughnut', {
                    labels: data.buyers_by_parish.map(item => item.parish),
                    datasets: [{
                        data: data.buyers_by_parish.map(item => item.buyer_count),
                        backgroundColor: generateColors(data.buyers_by_parish.length)
                    }]
                });
            }

            if (data.sellers_by_parish && data.sellers_by_parish.length > 0) {
                createChart('sellersParishChart', 'pie', {
                    labels: data.sellers_by_parish.map(item => item.parish),
                    datasets: [{
                        data: data.sellers_by_parish.map(item => item.seller_count),
                        backgroundColor: generateColors(data.sellers_by_parish.length)
                    }]
                });
            }

            if (data.orders_by_parish && data.orders_by_parish.length > 0) {
                createChart('ordersParishChart', 'bar', {
                    labels: data.orders_by_parish.map(item => item.parish),
                    datasets: [{
                        label: 'Orders',
                        data: data.orders_by_parish.map(item => item.order_count),
                        backgroundColor: '#4ECDC4'
                    }]
                }, {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false
                });
            }

            if (data.revenue_by_parish && data.revenue_by_parish.length > 0) {
                createChart('revenueParishChart', 'bar', {
                    labels: data.revenue_by_parish.map(item => item.parish),
                    datasets: [{
                        label: 'Revenue (JMD)',
                        data: data.revenue_by_parish.map(item => item.revenue),
                        backgroundColor: '#FFD700'
                    }]
                }, {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'J$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                });
            }
        }

        function createParishComparisonTable(data) {
            const tbody = document.getElementById('parishComparisonTable');
            tbody.innerHTML = '';

            if (!data.parish_stats || data.parish_stats.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div class="icon">üó∫Ô∏è</div>
                            <h3>No Parish Data</h3>
                            <p>Parish comparison will appear as users register</p>
                        </td>
                    </tr>
                `;
                return;
            }

            const totalRevenue = data.parish_stats.reduce((sum, parish) => sum + (parish.revenue || 0), 0);

            data.parish_stats.forEach(parish => {
                const avgOrderValue = parish.orders > 0 ? parish.revenue / parish.orders : 0;
                const marketShare = totalRevenue > 0 ? (parish.revenue / totalRevenue * 100) : 0;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${parish.parish}</strong></td>
                    <td>${parish.buyers.toLocaleString()}</td>
                    <td>${parish.sellers}</td>
                    <td>${parish.orders.toLocaleString()}</td>
                    <td>J$${parish.revenue.toLocaleString()}</td>
                    <td>J$${avgOrderValue.toLocaleString()}</td>
                    <td>${marketShare.toFixed(1)}%</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Generic chart creation function
        async function createChart(canvasId, type, data, options = {}) {
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if (!ctx) return;

            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }

            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: type === 'bar' ? 'top' : 'right'
                    }
                }
            };

            charts[canvasId] = new Chart(ctx, {
                type,
                data,
                options: { ...defaultOptions, ...options }
            });
        }

        function generateColors(count) {
            const colors = [
                '#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4',
                '#FECA57', '#FF9FF3', '#54A0FF', '#5F27CD', '#00D2D3',
                '#FF9F43', '#26de81', '#cd84f1', '#ffdd59', '#0fb9b1'
            ];
            return colors.slice(0, count);
        }

        // FIXED: Load Users with real data
        // FIXED: Load Users with proper error handling
async function loadUsers() {
    const tbody = document.getElementById('usersTableBody');
    if (!tbody) {
        console.error('usersTableBody element not found!');
        return;
    }

    tbody.innerHTML = '<tr><td colspan="9" class="loading"><div class="spinner"></div>Loading users...</td></tr>';

    try {
        console.log('üîÑ Calling /admin/api/users...');
        const response = await apiCall('/admin/api/users');
        console.log('üìä Users API response:', response);

        tbody.innerHTML = '';

        if (response.success && response.users && response.users.length > 0) {
            console.log(`‚úÖ Found ${response.users.length} users`);
            response.users.forEach(user => {
                const row = createUserRow(user);
                tbody.appendChild(row);
            });
        } else {
            console.log('‚ùå No users found or API error');
            tbody.innerHTML = '<tr><td colspan="9" class="empty-state"><div class="icon">üë•</div><h3>No users yet</h3><p>Users will appear here as they register</p></td></tr>';
        }
    } catch (error) {
        console.error('‚ùå Error loading users:', error);
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; color:#e74c3c;">Error loading users. Check console for details.</td></tr>';
    }
}

        function createUserRow(user) {
    const row = document.createElement('tr');

    // Format the location (parish or business address)
    const location = user.business_address || user.parish || 'N/A';

    // Determine user type
    const userType = user.is_seller ? 'Seller' : 'Buyer';
    const userTypeBadge = user.is_seller ? 'seller' : 'user';

    // Status based on flags
    const status = user.flag_count > 0 ? 'Flagged' : 'Active';
    const statusBadge = user.flag_count > 0 ? 'inactive' : 'active';

    row.innerHTML = `
        <td>
            <div><strong>${user.first_name || ''} ${user.last_name || ''}</strong></div>
            <div style="font-size: 12px; color: #666;">${user.email}</div>
        </td>
        <td>
            <div>${user.phone_number || 'N/A'}</div>
            <div style="font-size: 12px; color: #666;">${user.whatsapp_number || ''}</div>
        </td>
        <td>${location}</td>
        <td><span class="badge ${userTypeBadge}">${userType}</span></td>
        <td>${user.order_count || 0}</td>
        <td>${user.products_listed || 0}</td>
        <td>J$${(user.total_spent || 0).toFixed(2)}</td>
        <td><strong style="color: #27ae60;">J$${(user.seller_revenue || 0).toFixed(2)}</strong></td>
        <td><span class="badge ${statusBadge}">${status}</span></td>
        <td>
            <button class="btn btn-primary" onclick="viewUser('${user.email}')">View</button>
            ${user.flag_count > 0
                ? `<button class="btn btn-success" onclick="unflagUser('${user.email}')">Unflag</button>`
                : `<button class="btn btn-warning" onclick="flagUser('${user.email}')">Flag</button>`
            }
        </td>
    `;
    return row;
}

        // Load other sections with real data
        // COMPLETE ALL MISSING JAVASCRIPT FUNCTIONS
        // Replace your existing loadProducts, loadSellers, etc. with these:

        // FIXED: Load Products with real data
        async function loadProducts() {
            const tbody = document.getElementById('productsTableBody');
            if (!tbody) return;

            tbody.innerHTML = '<tr><td colspan="10" class="loading"><div class="spinner"></div>Loading products...</td></tr>';

            try {
                const response = await apiCall('/admin/api/products');
                tbody.innerHTML = '';

                if (response.success && response.products && response.products.length > 0) {
                    response.products.forEach(product => {
                        const row = createProductRow(product);
                        tbody.appendChild(row);
                    });
                    console.log(`Loaded ${response.products.length} products`);

                    // Create charts after products are loaded
                    createProductCategoryChart(response.products);
                    createBestSellingChart(response.products);
                } else {
                    tbody.innerHTML = '<tr><td colspan="10" class="empty-state"><div class="icon">üì¶</div><h3>No products yet</h3><p>Products will appear here as sellers add them</p></td></tr>';
                }
            } catch (error) {
                console.error('Error loading products:', error);
                tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; color:#e74c3c;">Error loading products</td></tr>';
            }
        }

        // Create Products by Category Chart
        function createProductCategoryChart(products) {
            if (!products || products.length === 0) return;

            // Group products by category
            const categoryCount = {};
            products.forEach(product => {
                const category = product.category || 'Uncategorized';
                categoryCount[category] = (categoryCount[category] || 0) + 1;
            });

            const categories = Object.keys(categoryCount);
            const counts = Object.values(categoryCount);

            createChart('productsCategoryChart', 'doughnut', {
                labels: categories,
                datasets: [{
                    data: counts,
                    backgroundColor: generateColors(categories.length),
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            }, {
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            font: { size: 12 },
                            padding: 15
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: ${value} products (${percentage}%)`;
                            }
                        }
                    }
                }
            });
        }

        // Create Best Selling Products Chart (Top 10)
        function createBestSellingChart(products) {
            if (!products || products.length === 0) return;

            // Sort products by sold quantity and get top 10
            const sortedProducts = [...products]
                .filter(p => (p.sold || 0) > 0)
                .sort((a, b) => (b.sold || 0) - (a.sold || 0))
                .slice(0, 10);

            if (sortedProducts.length === 0) {
                // Show message if no sales data
                const ctx = document.getElementById('bestSellingChart')?.getContext('2d');
                if (ctx) {
                    if (charts['bestSellingChart']) {
                        charts['bestSellingChart'].destroy();
                    }
                }
                return;
            }

            const labels = sortedProducts.map(p => {
                const name = p.name || 'Unknown Product';
                return name.length > 20 ? name.substring(0, 20) + '...' : name;
            });
            const salesData = sortedProducts.map(p => p.sold || 0);

            createChart('bestSellingChart', 'bar', {
                labels: labels,
                datasets: [{
                    label: 'Units Sold',
                    data: salesData,
                    backgroundColor: 'rgba(39, 174, 96, 0.8)',
                    borderColor: 'rgba(39, 174, 96, 1)',
                    borderWidth: 2
                }]
            }, {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Sold: ${context.parsed.x} units`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            });
        }

        function createProductRow(product) {
            const row = document.createElement('tr');

            // Format posted date
            const postedDate = product.posted_date ?
                new Date(product.posted_date).toLocaleDateString() : 'Unknown';

            // Calculate status based on stock
            const status = (product.amount > 0) ? 'In Stock' : 'Out of Stock';
            const statusClass = (product.amount > 0) ? 'active' : 'inactive';

            row.innerHTML = `
                <td>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <img src="/static/${product.image_url}" alt="${product.name}"
                             style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;"
                             onerror="this.src='/static/product-placeholder.svg'">
                        <div>
                            <strong>${product.name}</strong>
                            <div style="font-size: 12px; color: #666;">Key: ${product.product_key}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <div><strong>${product.seller_business_name || product.seller_first_name || ''} ${product.seller_last_name || ''}</strong></div>
                    <div style="font-size: 12px; color: #666;">${product.seller_email}</div>
                </td>
                <td><span class="badge">${product.category || 'Uncategorized'}</span></td>
                <td>J$${product.price}</td>
                <td>${product.amount || 0}</td>
                <td>${product.total_sold || product.sold || 0}</td>
                <td>J$${(product.total_revenue || 0).toFixed(2)}</td>
                <td>${postedDate}</td>
                <td><span class="badge ${statusClass}">${status}</span></td>
                <td>
                    <button class="btn btn-primary" onclick="viewProduct('${product.product_key}')">View</button>
                    <button class="btn btn-warning" onclick="flagProduct('${product.product_key}', '${product.seller_email}')">Flag</button>
                </td>
            `;
            return row;
        }

        // FIXED: Load Sellers with real data - OPTIMIZED VERSION
async function loadSellers() {
    const tbody = document.getElementById('sellersTableBody');
    if (!tbody) return;

    tbody.innerHTML = '<tr><td colspan="10" class="loading"><div class="spinner"></div>Loading sellers...</td></tr>';

    try {
        // üéØ Call the dedicated sellers endpoint (not users)
        const response = await apiCall('/admin/api/sellers');
        tbody.innerHTML = '';

        if (response.success && response.sellers && response.sellers.length > 0) {
            response.sellers.forEach(seller => {
                const row = createSellerRow(seller);
                tbody.appendChild(row);
            });
            console.log(`Loaded ${response.sellers.length} sellers`);
        } else {
            tbody.innerHTML = '<tr><td colspan="10" class="empty-state"><div class="icon">üè™</div><h3>No sellers yet</h3><p>Sellers will appear here as they register</p></td></tr>';
        }
    } catch (error) {
        console.error('Error loading sellers:', error);
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; color:#e74c3c;">Error loading sellers</td></tr>';
    }
}

        function createSellerRow(seller) {
            const row = document.createElement('tr');

            row.innerHTML = `
                <td>
                    <div><strong>${seller.first_name || ''} ${seller.last_name || ''}</strong></div>
                    <div style="font-size: 12px; color: #666;">${seller.email}</div>
                </td>
                <td>
                    <div><strong>${seller.business_name || 'N/A'}</strong></div>
                    <div style="font-size: 12px; color: #666;">${seller.business_address || seller.parish || 'N/A'}</div>
                </td>
                <td>${seller.business_address || seller.parish || 'N/A'}</td>
                <td>${seller.products_listed || 0}</td>
                <td><strong>${seller.total_sales || 0}</strong></td>
                <td><strong style="color: #27ae60;">J$${(seller.total_revenue || 0).toFixed(2)}</strong></td>
                <td>
                    <div style="display: flex; align-items: center;">
                        ${seller.avg_rating > 0 ?
                            `<span style="color: #FFD700;">${'‚òÖ'.repeat(Math.round(seller.avg_rating))}${'‚òÜ'.repeat(5 - Math.round(seller.avg_rating))}</span>` :
                            `<span style="color: #ddd;">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</span>`
                        }
                        <span style="margin-left: 5px; font-size: 12px; color: #666;">(${seller.rating_count || 0})</span>
                    </div>
                </td>
                <td><span class="badge ${seller.flag_count > 0 ? 'inactive' : 'active'}">${seller.flag_count > 0 ? 'Flagged' : 'Active'}</span></td>
                <td>
                    <label class="toggle-switch" title="${seller.cod_enabled ? 'Disable COD for this seller' : 'Enable COD for this seller'}">
                        <input type="checkbox" ${seller.cod_enabled ? 'checked' : ''}
                               onchange="toggleCOD('${seller.email}', this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                    <div style="font-size: 11px; color: ${seller.cod_enabled ? '#27ae60' : '#95a5a6'}; margin-top: 4px;">
                        ${seller.cod_enabled ? 'üíµ Enabled' : 'üö´ Disabled'}
                    </div>
                </td>
                <td>
                    <button class="btn btn-primary" onclick="viewSeller('${seller.email}')">View</button>
                    <button class="btn btn-warning" onclick="flagSeller('${seller.email}')">Flag</button>
                </td>
            `;
            return row;
        }

        // FIXED: Load Orders with real data
        async function loadOrders() {
            const tbody = document.getElementById('ordersTableBody');
            if (!tbody) return;

            tbody.innerHTML = '<tr><td colspan="9" class="loading"><div class="spinner"></div>Loading orders...</td></tr>';

            try {
                const response = await apiCall('/admin/api/orders');
                tbody.innerHTML = '';

                if (response.success && response.orders && response.orders.length > 0) {
                    response.orders.forEach(order => {
                        const row = createOrderRow(order);
                        tbody.appendChild(row);
                    });
                    console.log(`Loaded ${response.orders.length} orders`);
                } else {
                    tbody.innerHTML = '<tr><td colspan="10" class="empty-state"><div class="icon">üõí</div><h3>No orders yet</h3><p>Orders will appear here as customers make purchases</p></td></tr>';
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; color:#e74c3c;">Error loading orders</td></tr>';
            }
        }

        function createOrderRow(order) {
            const row = document.createElement('tr');

            // Format order date
            const orderDate = order.order_date ?
                new Date(order.order_date).toLocaleDateString() : 'Unknown';

            // Status badge
            const statusClass = {
                'pending': 'pending',
                'confirmed': 'active',
                'shipped': 'active',
                'delivered': 'completed',
                'cancelled': 'cancelled',
                'refunded': 'cancelled'
            }[order.status] || 'pending';

            // Payment verification badge
            const paymentVerifiedBadge = order.payment_verified
                ? '<span class="badge completed" style="background: #27ae60;">‚úì Verified</span>'
                : (order.payment_method === 'lynk' || order.payment_method === 'whatsapp')
                    ? '<span class="badge pending" style="background: #f39c12;">‚è≥ Pending</span>'
                    : '<span class="badge" style="background: #95a5a6;">N/A</span>';

            // Payment method display with Lynk reference
            let paymentMethodDisplay = order.payment_method || 'N/A';
            if (order.payment_method === 'lynk' && order.lynk_reference) {
                paymentMethodDisplay = `
                    <div><strong>Lynk</strong></div>
                    <div style="font-size: 11px; color: #666;">Ref: ${order.lynk_reference}</div>
                `;
            }

            row.innerHTML = `
                <td>
                    <div><strong>#${order.order_id.substring(0, 8)}</strong></div>
                    <div style="font-size: 12px; color: #666;">${order.order_id}</div>
                </td>
                <td>
                    <div><strong>${order.first_name || ''} ${order.last_name || ''}</strong></div>
                    <div style="font-size: 12px; color: #666;">${order.user_email}</div>
                </td>
                <td>${order.parish || 'N/A'}</td>
                <td>${order.item_count || 0} items</td>
                <td>J$${order.total}</td>
                <td>${paymentMethodDisplay}</td>
                <td>${orderDate}</td>
                <td><span class="badge ${statusClass}">${order.status || 'pending'}</span></td>
                <td>${paymentVerifiedBadge}</td>
                <td>
                    <button class="btn btn-primary" onclick="viewOrder('${order.order_id}')">View</button>
                    <button class="btn btn-warning" onclick="updateOrderStatus('${order.order_id}')">Update</button>
                    ${!order.payment_verified && (order.payment_method === 'lynk' || order.payment_method === 'whatsapp')
                        ? `<button class="btn" style="background: #27ae60; color: white;" onclick="verifyPayment('${order.order_id}', true)">‚úì Verify</button>
                           <button class="btn" style="background: #e74c3c; color: white;" onclick="verifyPayment('${order.order_id}', false)">‚úó Reject</button>`
                        : ''}
                </td>
            `;
            return row;
        }

        // FIXED: Load Financials with real data
        async function loadFinancials() {
            try {
                const response = await apiCall('/admin/api/financials');

                if (response.success) {
                    // Update financial stats
                    document.getElementById('totalRevenueFinancial').textContent = `J$${response.total_revenue.toFixed(2)}`;
                    document.getElementById('platformFeesFinancial').textContent = `J$${response.platform_fees.toFixed(2)}`;
                    document.getElementById('sellerPayouts').textContent = `J$${response.seller_payouts.toFixed(2)}`;
                    document.getElementById('totalRefunds').textContent = `J$${response.total_refunds.toFixed(2)}`;
                    document.getElementById('netProfit').textContent = `J$${response.net_profit.toFixed(2)}`;

                    // Calculate average order value
                    const avgOrderValue = response.total_revenue > 0 ? response.total_revenue / Math.max(1, response.monthly_data.reduce((sum, month) => sum + month.orders, 0)) : 0;
                    document.getElementById('avgOrderValue').textContent = `J$${avgOrderValue.toFixed(2)}`;

                    // Create monthly revenue chart
                    createMonthlyRevenueChart(response.monthly_data);
                    createRevenueBreakdownChart(response);
                } else {
                    console.error('Error loading financials:', response.message);
                }
            } catch (error) {
                console.error('Error loading financials:', error);
            }
        }

        function createMonthlyRevenueChart(monthlyData) {
            if (!monthlyData || monthlyData.length === 0) {
                const container = document.getElementById('monthlyRevenueChart');
                if (container) {
                    container.innerHTML = '<div class="empty-state"><div class="icon">üìä</div><h3>No Revenue Data</h3><p>Revenue charts will appear as orders are placed</p></div>';
                }
                return;
            }

            createChart('monthlyRevenueChart', 'line', {
                labels: monthlyData.map(item => item.month),
                datasets: [{
                    label: 'Monthly Revenue (JMD)',
                    data: monthlyData.map(item => item.revenue),
                    borderColor: '#FFD700',
                    backgroundColor: 'rgba(255, 215, 0, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            }, {
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'J$' + value.toLocaleString();
                            }
                        }
                    }
                }
            });
        }

        function createRevenueBreakdownChart(financialData) {
            createChart('revenueBreakdownChart', 'doughnut', {
                labels: ['Platform Fees (5%)', 'Seller Payouts (95%)', 'Refunds'],
                datasets: [{
                    data: [
                        financialData.platform_fees,
                        financialData.seller_payouts,
                        financialData.total_refunds
                    ],
                    backgroundColor: ['#FFD700', '#4ECDC4', '#FF6B6B']
                }]
            });
        }

        // FIXED: Load Demographics with sample data
        async function loadDemographics() {
            console.log('Loading demographics...');

            // Create sample demographic charts since we don't have this data yet
            createChart('userDemographicsChart', 'bar', {
                labels: ['18-25', '26-35', '36-45', '46-55', '55+'],
                datasets: [{
                    label: 'Users by Age Group',
                    data: [25, 35, 20, 15, 5],
                    backgroundColor: '#4ECDC4'
                }]
            });

            createChart('shoppingPatternsChart', 'line', {
                labels: ['6AM', '9AM', '12PM', '3PM', '6PM', '9PM'],
                datasets: [{
                    label: 'Shopping Activity',
                    data: [5, 15, 30, 25, 45, 35],
                    borderColor: '#FFD700',
                    backgroundColor: 'rgba(255, 215, 0, 0.1)',
                    fill: true
                }]
            });

            createChart('deviceUsageChart', 'pie', {
                labels: ['Mobile', 'Desktop', 'Tablet'],
                datasets: [{
                    data: [65, 30, 5],
                    backgroundColor: ['#FF6B6B', '#4ECDC4', '#FFD700']
                }]
            });

            createChart('growthTrendsChart', 'line', {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'New Users',
                    data: [10, 15, 25, 20, 30, 35],
                    borderColor: '#4ECDC4',
                    backgroundColor: 'rgba(76, 205, 196, 0.1)',
                    fill: true
                }]
            });
        }

        // FIXED: Load Activity Log with real data
        async function loadActivityLog() {
            const container = document.getElementById('activityLog');
            if (!container) return;

            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading activity log...</div>';

            try {
                const response = await apiCall('/admin/api/recent_activity');

                if (response.success && response.activities && response.activities.length > 0) {
                    container.innerHTML = '';
                    response.activities.forEach(activity => {
                        const activityItem = createActivityItem(activity);
                        container.appendChild(activityItem);
                    });
                } else {
                    container.innerHTML = createEmptyActivityState();
                }
            } catch (error) {
                console.error('Error loading activity log:', error);
                container.innerHTML = createEmptyActivityState();
            }
        }

        // FIXED: Load Admin Users with real data
        async function loadAdminUsers() {
            const tbody = document.getElementById('adminUsersTable');
            if (!tbody) return;

            tbody.innerHTML = '<tr><td colspan="7" class="loading"><div class="spinner"></div>Loading admin users...</td></tr>';

            try {
                const response = await apiCall('/admin/api/admin_users');
                tbody.innerHTML = '';

                if (response.success && response.admin_users && response.admin_users.length > 0) {
                    response.admin_users.forEach(admin => {
                        const row = createAdminUserRow(admin);
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><div class="icon">‚öôÔ∏è</div><h3>No admin users</h3><p>Admin users will appear here</p></td></tr>';
                }
            } catch (error) {
                console.error('Error loading admin users:', error);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#e74c3c;">Error loading admin users</td></tr>';
            }
        }

        function createAdminUserRow(admin) {
            const row = document.createElement('tr');

            const createdDate = admin.created_at ?
                new Date(admin.created_at).toLocaleDateString() : 'Unknown';
            const lastLogin = admin.last_login ?
                new Date(admin.last_login).toLocaleDateString() : 'Never';

            row.innerHTML = `
                <td>${admin.email}</td>
                <td><span class="badge ${admin.admin_level === 'super_admin' ? 'active' : 'user'}">${admin.admin_level}</span></td>
                <td>${admin.created_by || 'System'}</td>
                <td>${createdDate}</td>
                <td>${lastLogin}</td>
                <td><span class="badge ${admin.is_active ? 'active' : 'inactive'}">${admin.is_active ? 'Active' : 'Inactive'}</span></td>
                <td>
                    <button class="btn btn-primary" onclick="viewAdmin('${admin.email}')">View</button>
                    ${admin.admin_level !== 'super_admin' ? `<button class="btn btn-danger" onclick="deactivateAdmin('${admin.email}')">Deactivate</button>` : ''}
                </td>
            `;
            return row;
        }

        // Action functions
        async function viewProduct(productKey) {
            window.open(`/product/${encodeURIComponent(productKey.replace(/ /g, '+'))}`, '_blank');
        }

        async function flagProduct(productKey, sellerEmail) {
            const reason = prompt(`Why are you flagging product "${productKey}"?`);
            if (!reason || reason.trim() === '') {
                return;
            }

            if (!confirm(`Flag this product?\nSeller: ${sellerEmail}\nReason: ${reason}\n\nThis will flag the seller and hide ALL their product images.`)) {
                return;
            }

            // Flag the seller (which hides all their products)
            await flagUser(sellerEmail);
        }

        async function viewSeller(email) {
            const modal = document.getElementById('sellerModal');
            const modalBody = document.getElementById('sellerModalBody');
            const modalTitle = document.getElementById('modalSellerName');

            // Show modal with loading state
            modal.style.display = 'block';
            modalBody.innerHTML = '<div class="loading"><div class="spinner"></div>Loading seller details...</div>';
            modalTitle.textContent = 'Loading...';

            try {
                const response = await apiCall(`/admin/api/seller/${encodeURIComponent(email)}`);

                if (response.success) {
                    displaySellerDetails(response.seller);
                } else {
                    modalBody.innerHTML = `
                        <div class="no-data-message">
                            <h3>‚ùå Error Loading Seller</h3>
                            <p>${response.message || 'Unable to load seller details'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading seller details:', error);
                modalBody.innerHTML = `
                    <div class="no-data-message">
                        <h3>‚ùå Error</h3>
                        <p>Failed to load seller details. Please try again.</p>
                    </div>
                `;
            }
        }

        function displaySellerDetails(seller) {
            const modalTitle = document.getElementById('modalSellerName');
            const modalBody = document.getElementById('sellerModalBody');

            modalTitle.innerHTML = `${seller.business_name || seller.first_name + ' ' + seller.last_name} <span class="badge-large badge-seller">üè™ Seller</span>`;

            let html = `
                <div class="user-info-section">
                    <h3>üìä Seller Statistics</h3>
                    <div class="stats-summary">
                        <div class="stat-card">
                            <div class="stat-value">${seller.products_listed || 0}</div>
                            <div class="stat-label">Products Listed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${seller.total_sales || 0}</div>
                            <div class="stat-label">Total Sales</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">J$${(seller.total_revenue || 0).toFixed(2)}</div>
                            <div class="stat-label">Total Revenue</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${seller.avg_rating > 0 ? seller.avg_rating.toFixed(1) : '0.0'} ‚≠ê</div>
                            <div class="stat-label">Rating (${seller.rating_count || 0})</div>
                        </div>
                    </div>
                </div>

                ${seller.flag_count > 0 ? `
                <div class="flag-section">
                    <h3 style="color: #e74c3c;">‚ö†Ô∏è This seller has ${seller.flag_count} active flag(s)</h3>
                    <p>Product images are hidden from public view.</p>
                </div>
                ` : ''}

                <div class="user-info-section">
                    <h3>üìã Seller Information</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Email</div>
                            <div class="info-value">${seller.email}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Full Name</div>
                            <div class="info-value">${seller.first_name || ''} ${seller.last_name || ''}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Business Name</div>
                            <div class="info-value">${seller.business_name || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Phone Number</div>
                            <div class="info-value">${seller.phone_number || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Parish</div>
                            <div class="info-value">${seller.parish || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Business Address</div>
                            <div class="info-value">${seller.business_address || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Verification Status</div>
                            <div class="info-value">${seller.verification_status === 'verified' ? '‚úÖ Verified' : seller.verification_status === 'pending' ? '‚è≥ Pending' : '‚ùå Not Verified'}</div>
                        </div>
                        ${seller.verification_date ? `
                        <div class="info-item">
                            <div class="info-label">Verified On</div>
                            <div class="info-value">${new Date(seller.verification_date).toLocaleDateString()}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>

                ${seller.business_description ? `
                <div class="user-info-section">
                    <h3>üìù Business Description</h3>
                    <p>${seller.business_description}</p>
                </div>
                ` : ''}

                <div class="modal-actions">
                    <button class="modal-btn modal-btn-primary" onclick="window.open('/seller/${seller.email}', '_blank')">üè™ Visit Store</button>
                    ${seller.flag_count > 0 ?
                        `<button class="modal-btn modal-btn-unflag" onclick="unflagSellerFromModal('${seller.email}')">‚úì Unflag Seller</button>` :
                        `<button class="modal-btn modal-btn-flag" onclick="flagSellerFromModal('${seller.email}')">‚ö† Flag Seller</button>`
                    }
                    <button class="modal-btn modal-btn-close" onclick="closeSellerModal()">Close</button>
                </div>
            `;

            modalBody.innerHTML = html;
        }

        async function flagSeller(email) {
            const reason = prompt('Why are you flagging this seller?');
            if (!reason || reason.trim() === '') return;

            if (!confirm(`Flag ${email} for: ${reason}?\n\nThis will hide all their product images.`)) return;

            try {
                const response = await apiCall('/admin/api/flag_user', {
                    method: 'POST',
                    body: JSON.stringify({
                        user_email: email,
                        flag_type: 'suspended',
                        reason: reason,
                        expires_days: null
                    })
                });

                if (response.success) {
                    showNotification(`Seller flagged - all product images hidden`, 'success');
                    await loadSellers();
                } else {
                    showNotification(`Failed: ${response.message}`, 'error');
                }
            } catch (error) {
                console.error('Error flagging seller:', error);
                showNotification('Error flagging seller', 'error');
            }
        }

        async function flagSellerFromModal(email) {
            await flagSeller(email);
            await viewSeller(email);
        }

        async function unflagSellerFromModal(email) {
            if (!confirm(`Remove all flags from ${email}?\n\nTheir products will become visible again.`)) return;

            try {
                const response = await apiCall('/admin/api/unflag_user', {
                    method: 'POST',
                    body: JSON.stringify({ user_email: email })
                });

                if (response.success) {
                    showNotification(`Seller unflagged - products now visible`, 'success');
                    await viewSeller(email);
                    await loadSellers();
                } else {
                    showNotification(`Failed: ${response.message}`, 'error');
                }
            } catch (error) {
                console.error('Error unflagging seller:', error);
                showNotification('Error unflagging seller', 'error');
            }
        }

        function closeSellerModal() {
            document.getElementById('sellerModal').style.display = 'none';
        }

        // Toggle COD access for a seller
        async function toggleCOD(email, enabled) {
            try {
                const response = await apiCall('/admin/api/toggle_cod', {
                    method: 'POST',
                    body: JSON.stringify({
                        seller_email: email,
                        cod_enabled: enabled
                    })
                });

                if (response.success) {
                    showNotification(
                        `üíµ COD ${enabled ? 'enabled' : 'disabled'} for ${email}`,
                        'success'
                    );
                    await loadSellers(); // Reload to reflect changes
                } else {
                    showNotification(`Failed: ${response.message}`, 'error');
                    // Revert the toggle if failed
                    await loadSellers();
                }
            } catch (error) {
                console.error('Error toggling COD:', error);
                showNotification('Error updating COD access', 'error');
                // Revert the toggle if failed
                await loadSellers();
            }
        }

        async function viewOrder(orderId) {
            // Open order tracking page in new tab
            window.open(`/track_order?order_id=${orderId}`, '_blank');
        }

        async function updateOrderStatus(orderId) {
            const newStatus = prompt('Update order status to:\n\npending | confirmed | shipped | delivered | cancelled');
            if (!newStatus) return;

            const validStatuses = ['pending', 'confirmed', 'shipped', 'delivered', 'cancelled'];
            if (!validStatuses.includes(newStatus.toLowerCase())) {
                showNotification('Invalid status. Use: pending, confirmed, shipped, delivered, or cancelled', 'error');
                return;
            }

            if (!confirm(`Change order ${orderId.substring(0, 8)} to: ${newStatus}?`)) {
                return;
            }

            try {
                const response = await apiCall('/admin/api/update_order_status', {
                    method: 'POST',
                    body: JSON.stringify({
                        order_id: orderId,
                        status: newStatus.toLowerCase()
                    })
                });

                if (response.success) {
                    showNotification(`Order status updated to: ${newStatus}`, 'success');
                    await loadOrders();
                } else {
                    showNotification(`Failed: ${response.message}`, 'error');
                }
            } catch (error) {
                console.error('Error updating order status:', error);
                showNotification('Error updating order status', 'error');
            }
        }

        async function verifyPayment(orderId, verified) {
            const action = verified ? 'verify' : 'reject';
            const shortId = orderId.substring(0, 8);

            if (!confirm(`${verified ? '‚úì Verify' : '‚úó Reject'} payment for order ${shortId}?\n\n${verified ? 'This will mark the payment as verified and change status to confirmed.' : 'This will reject the payment and keep status as pending_payment.'}`)) {
                return;
            }

            try {
                const response = await apiCall('/admin/verify_lynk_payment', {
                    method: 'POST',
                    body: JSON.stringify({
                        order_id: orderId,
                        verified: verified
                    })
                });

                if (response.success) {
                    showNotification(`Payment ${verified ? 'verified' : 'rejected'} successfully!`, 'success');
                    await loadOrders();
                } else {
                    showNotification(`Failed: ${response.message}`, 'error');
                }
            } catch (error) {
                console.error('Error verifying payment:', error);
                showNotification('Error verifying payment', 'error');
            }
        }

        async function viewAdmin(email) {
            showNotification(`Viewing admin: ${email}`, 'info');
        }

        async function deactivateAdmin(email) {
            if (confirm(`Are you sure you want to deactivate admin: ${email}?`)) {
                showNotification(`Admin ${email} deactivated`, 'warning');
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadSectionData('dashboard');
        });

        // Search functionality
        function setupSearchFilters() {
            const searchInputs = document.querySelectorAll('[id$="Search"]');
            searchInputs.forEach(input => {
                input.addEventListener('input', debounce((e) => {
                    const tableId = e.target.id.replace('Search', 'TableBody');
                    filterTable(tableId, e.target.value);
                }, 300));
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function filterTable(tableBodyId, query) {
            const tbody = document.getElementById(tableBodyId);
            if (!tbody) return;

            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query.toLowerCase()) ? '' : 'none';
            });
        }

        // Setup search filters after DOM load
        document.addEventListener('DOMContentLoaded', setupSearchFilters);

        // Customer Chat Functions
        let selectedConversation = null;

        function loadChats() {
            console.log('Loading chats...');

            // Simulate loading conversations from the database
            fetch('/admin/api/conversations')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayConversations(data.conversations);
                    } else {
                        console.error('Failed to load conversations');
                        displayNoConversations();
                    }
                })
                .catch(error => {
                    console.error('Error loading conversations:', error);
                    displayNoConversations();
                });
        }

        function displayConversations(conversations) {
            const container = document.getElementById('conversationsList');

            if (!conversations || conversations.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 20px;">üì≠</div>
                        <h4>No conversations yet</h4>
                        <p>Customer chats will appear here</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = conversations.map(conv => `
                <div class="conversation-item" onclick="selectConversation('${conv.session_id}', '${conv.user_email}')">
                    <h5>üáØüá≤ ${conv.user_email}</h5>
                    <p>Last active: ${formatTime(conv.last_message_time)}</p>
                    <p>Messages: ${conv.message_count}</p>
                    ${conv.unread_count > 0 ? `<span style="background: #e74c3c; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">${conv.unread_count} new</span>` : ''}
                </div>
            `).join('');
        }

        function displayNoConversations() {
            const container = document.getElementById('conversationsList');
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üîå</div>
                    <h4>Connection Issue</h4>
                    <p>Unable to load conversations</p>
                    <button onclick="loadChats()" style="padding: 8px 16px; background: #FFD700; border: none; border-radius: 8px; margin-top: 10px; cursor: pointer;">üîÑ Retry</button>
                </div>
            `;
        }

        function selectConversation(sessionId, userEmail) {
            selectedConversation = { sessionId, userEmail };

            // Update UI
            document.querySelectorAll('.conversation-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.conversation-item').classList.add('active');

            // Load messages for this conversation
            loadMessages(sessionId);

            // Show reply section
            document.getElementById('replySection').style.display = 'block';
        }

        function loadMessages(sessionId) {
            fetch(`/admin/api/conversation/${sessionId}/messages`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayMessages(data.messages);
                    } else {
                        console.error('Failed to load messages');
                        displayNoMessages();
                    }
                })
                .catch(error => {
                    console.error('Error loading messages:', error);
                    displayNoMessages();
                });
        }

        function displayMessages(messages) {
            const container = document.getElementById('chatMessages');

            if (!messages || messages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 100px 20px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 20px;">üí¨</div>
                        <h3>No messages yet</h3>
                        <p>Start the conversation by sending a message</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = messages.map(msg => `
                <div class="message-item ${msg.sender}">
                    ${escapeHtml(msg.message)}
                    <span class="message-time">${formatTime(msg.timestamp)}</span>
                </div>
            `).join('');

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        function displayNoMessages() {
            const container = document.getElementById('chatMessages');
            container.innerHTML = `
                <div style="text-align: center; padding: 100px 20px; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                    <h3>Error loading messages</h3>
                    <p>Unable to fetch conversation messages</p>
                </div>
            `;
        }

        function sendAdminReply() {
            if (!selectedConversation) {
                alert('Please select a conversation first');
                return;
            }

            const replyInput = document.getElementById('adminReply');
            const message = replyInput.value.trim();

            if (!message) {
                alert('Please enter a message');
                return;
            }

            // Send the reply
            fetch('/admin/api/send_reply', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                },
                body: JSON.stringify({
                    session_id: selectedConversation.sessionId,
                    user_email: selectedConversation.userEmail,
                    message: message
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    replyInput.value = '';
                    loadMessages(selectedConversation.sessionId);
                    loadChats(); // Refresh conversation list
                } else {
                    alert('Failed to send message: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error sending reply:', error);
                alert('Error sending message');
            });
        }

        function formatTime(timestamp) {
            if (!timestamp) return 'Unknown';
            const date = new Date(timestamp);
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load chats when the chats section becomes active
        document.addEventListener('DOMContentLoaded', function() {
            // If chats section is shown, load conversations
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    const chatsSection = document.getElementById('chats');
                    if (chatsSection && chatsSection.style.display !== 'none' &&
                        chatsSection.classList.contains('active') ||
                        window.location.hash === '#chats') {
                        loadChats();
                    }
                });
            });

            // Auto-load chats if directly accessing #chats
            if (window.location.hash === '#chats') {
                setTimeout(loadChats, 1000);
            }
        });

        // USER MANAGEMENT FUNCTIONS - View User Details Modal
        let currentUserEmail = null;

        async function viewUser(email) {
            currentUserEmail = email;
            const modal = document.getElementById('userModal');
            const modalBody = document.getElementById('userModalBody');
            const modalTitle = document.getElementById('modalUserName');

            // Show modal with loading state
            modal.style.display = 'block';
            modalBody.innerHTML = '<div class="loading"><div class="spinner"></div>Loading user details...</div>';
            modalTitle.textContent = 'Loading...';

            try {
                const response = await apiCall(`/admin/api/user_details/${encodeURIComponent(email)}`);

                if (response.success) {
                    displayUserDetails(response);
                } else {
                    modalBody.innerHTML = `
                        <div class="no-data-message">
                            <h3>‚ùå Error Loading User</h3>
                            <p>${response.message || 'Unable to load user details'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading user details:', error);
                modalBody.innerHTML = `
                    <div class="no-data-message">
                        <h3>‚ùå Error</h3>
                        <p>Failed to load user details. Please try again.</p>
                    </div>
                `;
            }
        }

        function displayUserDetails(data) {
            const user = data.user;
            const flags = data.flags || [];
            const orders = data.orders || [];
            const products = data.products || [];

            const modalTitle = document.getElementById('modalUserName');
            const modalBody = document.getElementById('userModalBody');

            // Update modal title
            modalTitle.innerHTML = `${user.first_name || ''} ${user.last_name || ''} <span class="badge-large ${user.is_seller ? 'badge-seller' : 'badge-buyer'}">${user.is_seller ? 'üè™ Seller' : 'üë§ Buyer'}</span>`;

            let html = '';

            // Show flags if any
            if (flags.length > 0) {
                html += `
                    <div class="flag-section">
                        <h3 style="color: #e74c3c; margin-bottom: 15px;">‚ö†Ô∏è Active Flags (${flags.length})</h3>
                        <div style="background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #e74c3c;">
                            <strong style="color: #e74c3c;">üö´ All product images are currently hidden from public view</strong>
                        </div>
                        ${flags.map(flag => `
                            <div class="flag-item">
                                <div class="flag-type">${flag.flag_type || 'Warning'}</div>
                                <div style="margin: 8px 0;"><strong>Reason:</strong> ${flag.reason || 'N/A'}</div>
                                <div style="font-size: 12px; color: #666;">
                                    <strong>Flagged by:</strong> ${flag.flagged_by || 'Admin'} on ${flag.flag_date ? new Date(flag.flag_date).toLocaleString() : 'Unknown'}
                                </div>
                                ${flag.expires_at ? `<div style="font-size: 12px; color: #666;"><strong>Expires:</strong> ${new Date(flag.expires_at).toLocaleString()}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Calculate statistics
            const totalOrderValue = orders.reduce((sum, order) => sum + (parseFloat(order.total) || 0), 0);
            const totalProductRevenue = products.reduce((sum, product) => sum + ((product.sold || 0) * (product.price || 0)), 0);
            const totalStock = products.reduce((sum, product) => sum + (product.amount || 0), 0);
            const totalSold = products.reduce((sum, product) => sum + (product.sold || 0), 0);

            // Statistics Summary
            if (user.is_seller && products.length > 0) {
                html += `
                    <div class="user-info-section">
                        <h3>üìä Seller Statistics</h3>
                        <div class="stats-summary">
                            <div class="stat-card">
                                <div class="stat-value">${products.length}</div>
                                <div class="stat-label">Products Listed</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${totalSold}</div>
                                <div class="stat-label">Total Items Sold</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${totalStock}</div>
                                <div class="stat-label">Current Stock</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">J$${totalProductRevenue.toFixed(2)}</div>
                                <div class="stat-label">Total Revenue</div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (!user.is_seller && orders.length > 0) {
                html += `
                    <div class="user-info-section">
                        <h3>üìä Buyer Statistics</h3>
                        <div class="stats-summary">
                            <div class="stat-card">
                                <div class="stat-value">${orders.length}</div>
                                <div class="stat-label">Total Orders</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">J$${totalOrderValue.toFixed(2)}</div>
                                <div class="stat-label">Total Spent</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">J$${(totalOrderValue / orders.length).toFixed(2)}</div>
                                <div class="stat-label">Avg Order Value</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Personal Information Section
            html += `
                <div class="user-info-section">
                    <h3>üìã Personal Information</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Email</div>
                            <div class="info-value">${user.email}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Full Name</div>
                            <div class="info-value">${user.first_name || ''} ${user.last_name || ''}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Phone Number</div>
                            <div class="info-value">${user.phone_number || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">WhatsApp Number</div>
                            <div class="info-value">${user.whatsapp_number || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Parish</div>
                            <div class="info-value">${user.parish || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Account Created</div>
                            <div class="info-value">${user.created_at ? new Date(user.created_at).toLocaleDateString() : 'N/A'}</div>
                        </div>
                        ${user.is_seller ? `
                            <div class="info-item">
                                <div class="info-label">Business Name</div>
                                <div class="info-value">${user.business_name || 'N/A'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Business Address</div>
                                <div class="info-value">${user.business_address || 'N/A'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Verification Status</div>
                                <div class="info-value">${user.verification_status === 'verified' ? '‚úÖ Verified' : user.verification_status === 'pending' ? '‚è≥ Pending' : '‚ùå Not Verified'}</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            // Orders Section (for buyers or sellers who also buy)
            if (orders.length > 0) {
                html += `
                    <div class="user-info-section">
                        <h3>üõí Order History (${orders.length} orders)</h3>
                        <table class="orders-table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Date</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${orders.map(order => `
                                    <tr>
                                        <td>#${order.order_id.substring(0, 8)}</td>
                                        <td>${order.order_date ? new Date(order.order_date).toLocaleDateString() : 'N/A'}</td>
                                        <td>${order.item_count || 0} items</td>
                                        <td>J$${order.total || 0}</td>
                                        <td><span class="badge ${order.status === 'delivered' ? 'completed' : order.status === 'cancelled' ? 'cancelled' : 'pending'}">${order.status || 'pending'}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else if (!user.is_seller) {
                html += `
                    <div class="user-info-section">
                        <h3>üõí Order History</h3>
                        <div class="no-data-message">No orders placed yet</div>
                    </div>
                `;
            }

            // Products Section (for sellers)
            if (user.is_seller) {
                if (products.length > 0) {
                    const isFlagged = flags.length > 0;
                    html += `
                        <div class="user-info-section">
                            <h3>üì¶ Products Listed (${products.length} products)</h3>
                            ${isFlagged ? `
                                <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 12px; margin-bottom: 15px;">
                                    <strong>‚ö†Ô∏è Note:</strong> Product images are currently hidden from public view due to active flags.
                                    Images shown here are for admin reference only.
                                </div>
                            ` : ''}
                            <div class="products-grid">
                                ${products.map(product => {
                                    const revenue = (product.sold || 0) * (product.price || 0);
                                    return `
                                    <div class="product-card-modal ${isFlagged ? 'flagged' : ''}">
                                        ${isFlagged ? '<div class="flagged-overlay">üö´ Images Hidden</div>' : ''}
                                        <img src="/static/${product.image_url || 'product-placeholder.svg'}"
                                             alt="${product.name}"
                                             onerror="this.src='/static/product-placeholder.svg'"
                                             style="${isFlagged ? 'opacity: 0.6; filter: grayscale(50%);' : ''}">
                                        <div class="product-info">
                                            <div class="product-name">${product.name}</div>
                                            <div class="product-price">J$${product.price}</div>
                                            <div class="product-revenue">Revenue: J$${revenue.toFixed(2)}</div>
                                            <div class="product-stats">
                                                <span>Stock: ${product.amount || 0}</span>
                                                <span>Sold: ${product.sold || 0}</span>
                                            </div>
                                            <div style="margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap;">
                                                <span class="badge">${product.category || 'Uncategorized'}</span>
                                                ${product.amount <= 0 ? '<span class="badge inactive">Out of Stock</span>' : ''}
                                            </div>
                                            <div style="margin-top: 8px; font-size: 11px; color: #666;">
                                                Posted: ${product.posted_date ? new Date(product.posted_date).toLocaleDateString() : 'N/A'}
                                            </div>
                                        </div>
                                    </div>
                                `}).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="user-info-section">
                            <h3>üì¶ Products Listed</h3>
                            <div class="no-data-message">No products listed yet</div>
                        </div>
                    `;
                }
            }

            // Action Buttons
            html += `
                <div class="modal-actions">
                    ${flags.length > 0 ?
                        `<button class="modal-btn modal-btn-unflag" onclick="unflagUserFromModal('${user.email}')">‚úì Unflag User</button>` :
                        `<button class="modal-btn modal-btn-flag" onclick="flagUserFromModal('${user.email}')">‚ö† Flag User</button>`
                    }
                    <button class="modal-btn modal-btn-close" onclick="closeUserModal()">Close</button>
                </div>
            `;

            modalBody.innerHTML = html;
        }

        async function flagUser(email) {
            const reason = prompt('Why are you flagging this user?');
            if (!reason || reason.trim() === '') {
                return;
            }

            if (!confirm(`Flag ${email} for: ${reason}?\n\nThis will hide all their product images.`)) {
                return;
            }

            try {
                const response = await apiCall('/admin/api/flag_user', {
                    method: 'POST',
                    body: JSON.stringify({
                        user_email: email,
                        flag_type: 'suspended',
                        reason: reason,
                        expires_days: null
                    })
                });

                if (response.success) {
                    showNotification(`User flagged - all product images hidden`, 'success');
                    await loadUsers();
                } else {
                    showNotification(`Failed: ${response.message}`, 'error');
                }
            } catch (error) {
                console.error('Error flagging user:', error);
                showNotification('Error flagging user', 'error');
            }
        }

        async function flagUserFromModal(email) {
            await flagUser(email);
            // Refresh the modal
            await viewUser(email);
        }

        async function unflagUser(email) {
            if (!confirm(`Remove all flags from ${email}?\n\nTheir products will become visible again.`)) {
                return;
            }

            try {
                const response = await apiCall('/admin/api/unflag_user', {
                    method: 'POST',
                    body: JSON.stringify({
                        user_email: email
                    })
                });

                if (response.success) {
                    showNotification(`User unflagged - products now visible`, 'success');
                    await loadUsers();
                } else {
                    showNotification(`Failed: ${response.message}`, 'error');
                }
            } catch (error) {
                console.error('Error unflagging user:', error);
                showNotification('Error unflagging user', 'error');
            }
        }

        async function unflagUserFromModal(email) {
            if (!confirm(`Are you sure you want to remove all flags from ${email}?`)) {
                return;
            }

            try {
                const response = await apiCall('/admin/api/unflag_user', {
                    method: 'POST',
                    body: JSON.stringify({
                        user_email: email
                    })
                });

                if (response.success) {
                    showNotification(`User ${email} has been unflagged successfully`, 'success');
                    // Refresh the modal
                    await viewUser(email);
                    // Reload users table
                    await loadUsers();
                } else {
                    showNotification(`Failed to unflag user: ${response.message}`, 'error');
                }
            } catch (error) {
                console.error('Error unflagging user:', error);
                showNotification('Error unflagging user', 'error');
            }
        }

        function closeUserModal() {
            const modal = document.getElementById('userModal');
            modal.style.display = 'none';
            currentUserEmail = null;
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('userModal');
            if (event.target == modal) {
                closeUserModal();
            }
        }

        // PAYOUT APPROVAL FUNCTIONS
        async function loadPendingPayouts() {
            const tbody = document.getElementById('payoutsTableBody');
            const summary = document.getElementById('payoutSummary');

            if (!tbody) return;

            tbody.innerHTML = '<tr><td colspan="9" class="loading"><div class="spinner"></div>Loading pending payouts...</td></tr>';

            try {
                const response = await apiCall('/admin/api/pending_payouts');
                tbody.innerHTML = '';

                if (response.success && response.payouts && response.payouts.length > 0) {
                    response.payouts.forEach(payout => {
                        const row = createPayoutRow(payout);
                        tbody.appendChild(row);
                    });

                    // Show summary
                    document.getElementById('totalPendingCount').textContent = response.summary.total_pending;
                    document.getElementById('totalPendingAmount').textContent = response.summary.total_amount.toFixed(2);
                    summary.style.display = 'block';

                    console.log(`Loaded ${response.payouts.length} pending payouts`);
                } else {
                    tbody.innerHTML = '<tr><td colspan="9" class="empty-state"><div class="icon">üí∏</div><h3>No pending payouts</h3><p>All seller payout requests have been processed</p></td></tr>';
                    summary.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading pending payouts:', error);
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; color:#e74c3c;">Error loading payouts</td></tr>';
                summary.style.display = 'none';
            }
        }

        function createPayoutRow(payout) {
            const row = document.createElement('tr');

            const requestDate = payout.request_date ?
                new Date(payout.request_date).toLocaleString() : 'Unknown';

            const methodIcon = {
                'card': 'üí≥',
                'mobile': 'üì±',
                'bank': 'üè¶',
                'lynk': 'üì±'
            }[payout.method] || 'üí∞';

            row.innerHTML = `
                <td>
                    <div><strong>${payout.first_name || ''} ${payout.last_name || ''}</strong></div>
                    <div style="font-size: 12px; color: #666;">${payout.seller_email}</div>
                </td>
                <td>
                    <div>${methodIcon} ${payout.method ? payout.method.charAt(0).toUpperCase() + payout.method.slice(1) : 'N/A'}</div>
                </td>
                <td>
                    <div style="font-size: 13px;">
                        ${payout.account_number ? `<div><strong>Account:</strong> ${payout.account_number}</div>` : ''}
                        ${payout.account_name ? `<div><strong>Name:</strong> ${payout.account_name}</div>` : ''}
                        ${payout.bank_name ? `<div><strong>Bank:</strong> ${payout.bank_name}</div>` : ''}
                        ${!payout.account_number && !payout.account_name && !payout.bank_name ? '<div style="color: #e74c3c;">‚ö†Ô∏è No payment details</div>' : ''}
                    </div>
                </td>
                <td><strong>J$${payout.amount ? payout.amount.toFixed(2) : '0.00'}</strong></td>
                <td style="color: #e67e22;">J$${payout.fee ? payout.fee.toFixed(2) : '0.00'}</td>
                <td><strong style="color: #27ae60;">J$${payout.net_amount ? payout.net_amount.toFixed(2) : '0.00'}</strong></td>
                <td>${payout.processing_time || 'N/A'}</td>
                <td style="font-size: 12px;">${requestDate}</td>
                <td>
                    <button class="btn btn-success" onclick="approvePayout(${payout.id}, '${payout.seller_email}', ${payout.net_amount})">
                        ‚úì Approve
                    </button>
                    <button class="btn btn-danger" onclick="rejectPayout(${payout.id}, '${payout.seller_email}')">
                        ‚úó Reject
                    </button>
                </td>
            `;
            return row;
        }

        async function approvePayout(payoutId, sellerEmail, netAmount) {
            if (!confirm(`Approve payout of J$${netAmount.toFixed(2)} for ${sellerEmail}?\n\nThis action will mark the payout as completed.`)) {
                return;
            }

            try {
                const response = await apiCall('/admin/api/approve_payout', {
                    method: 'POST',
                    body: JSON.stringify({ payout_id: payoutId })
                });

                if (response.success) {
                    showNotification(`‚úÖ Payout approved: J$${netAmount.toFixed(2)} for ${sellerEmail}`, 'success', 6000);
                    await loadPendingPayouts();
                    await loadPayoutHistory();
                    await loadFinancials(); // Refresh financial stats
                } else {
                    showNotification(`‚ùå Failed: ${response.message}`, 'error');
                }
            } catch (error) {
                console.error('Error approving payout:', error);
                showNotification('‚ùå Error approving payout', 'error');
            }
        }

        async function rejectPayout(payoutId, sellerEmail) {
            const reason = prompt(`Why are you rejecting this payout request for ${sellerEmail}?`);
            if (!reason || reason.trim() === '') {
                return;
            }

            if (!confirm(`Reject payout request for ${sellerEmail}?\nReason: ${reason}\n\nThe funds will be returned to the seller's balance.`)) {
                return;
            }

            try {
                const response = await apiCall('/admin/api/reject_payout', {
                    method: 'POST',
                    body: JSON.stringify({
                        payout_id: payoutId,
                        reason: reason
                    })
                });

                if (response.success) {
                    showNotification(`Payout rejected for ${sellerEmail}. Funds returned to balance.`, 'warning', 6000);
                    await loadPendingPayouts();
                    await loadPayoutHistory();
                } else {
                    showNotification(`Failed: ${response.message}`, 'error');
                }
            } catch (error) {
                console.error('Error rejecting payout:', error);
                showNotification('Error rejecting payout', 'error');
            }
        }

        async function loadPayoutHistory() {
            const tbody = document.getElementById('payoutHistoryTableBody');
            if (!tbody) return;

            tbody.innerHTML = '<tr><td colspan="7" class="loading"><div class="spinner"></div>Loading payout history...</td></tr>';

            try {
                const filter = document.getElementById('payoutStatusFilter')?.value || 'all';
                const response = await apiCall(`/admin/api/payout_history?status=${filter}`);
                tbody.innerHTML = '';

                if (response.success && response.payouts && response.payouts.length > 0) {
                    response.payouts.forEach(payout => {
                        const row = createPayoutHistoryRow(payout);
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><div class="icon">üìú</div><h3>No payout history</h3><p>Completed payouts will appear here</p></td></tr>';
                }
            } catch (error) {
                console.error('Error loading payout history:', error);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#e74c3c;">Error loading history</td></tr>';
            }
        }

        function createPayoutHistoryRow(payout) {
            const row = document.createElement('tr');

            const requestDate = payout.request_date ?
                new Date(payout.request_date).toLocaleDateString() : 'Unknown';
            const completedDate = payout.completed_date ?
                new Date(payout.completed_date).toLocaleDateString() : 'N/A';

            const statusClass = {
                'completed': 'completed',
                'failed': 'cancelled'
            }[payout.status] || 'pending';

            row.innerHTML = `
                <td>
                    <div><strong>${payout.first_name || ''} ${payout.last_name || ''}</strong></div>
                    <div style="font-size: 12px; color: #666;">${payout.seller_email}</div>
                </td>
                <td>${payout.method ? payout.method.charAt(0).toUpperCase() + payout.method.slice(1) : 'N/A'}</td>
                <td>J$${payout.amount ? payout.amount.toFixed(2) : '0.00'}</td>
                <td><strong style="color: #27ae60;">J$${payout.net_amount ? payout.net_amount.toFixed(2) : '0.00'}</strong></td>
                <td><span class="badge ${statusClass}">${payout.status || 'unknown'}</span></td>
                <td style="font-size: 12px;">${requestDate}</td>
                <td style="font-size: 12px;">${completedDate}</td>
            `;
            return row;
        }

        // Auto-load payouts when financials section is shown
        const originalLoadFinancials = loadFinancials;
        loadFinancials = async function() {
            await originalLoadFinancials();
            await loadPendingPayouts();
            await loadPayoutHistory();
        };
    </script>

    <!-- User Details Modal -->
    <div id="userModal" class="user-modal">
        <div class="user-modal-content">
            <div class="user-modal-header">
                <h2 id="modalUserName">User Details</h2>
                <span class="close-modal" onclick="closeUserModal()">&times;</span>
            </div>
            <div class="user-modal-body" id="userModalBody">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading user details...
                </div>
            </div>
        </div>
    </div>

    <!-- Seller Details Modal -->
    <div id="sellerModal" class="user-modal">
        <div class="user-modal-content">
            <div class="user-modal-header">
                <h2 id="modalSellerName">Seller Details</h2>
                <span class="close-modal" onclick="closeSellerModal()">&times;</span>
            </div>
            <div class="user-modal-body" id="sellerModalBody">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading seller details...
                </div>
            </div>
        </div>
    </div>

</body>
</html>